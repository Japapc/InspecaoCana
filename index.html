<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Inspeção e Planejamento de Cana com IA</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
    :root {
        --color-primary: #2e7d32;
        --color-primary-dark: #1b5e20;
        --color-accent: #4caf50;
        --color-bg: #f5f5f5;
        --color-text: #333333;
        --color-text-light: #555555;
        --color-white: #ffffff;
        --color-border: #e0e0e0;
        --color-danger: #d32f2f;
        --color-success: #388e3c;
        --color-warning: #f57c00;
        --color-info: #1976d2;
        --color-purple: #7b1fa2;
        --color-ai: #6a1b9a; /* Roxo para IA */
        --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        --font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
        --border-radius: 12px;
        --border-radius-lg: 16px;
        --border-radius-xl: 20px;
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { margin: 0; font-family: var(--font-family); background-color: var(--color-bg); color: var(--color-text); min-height: 100vh; display: flex; flex-direction: column; line-height: 1.5; -webkit-font-smoothing: antialiased; }
    #loginScreen { flex: 1; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark)); display: flex; justify-content: center; align-items: center; padding: 20px; background-image: radial-gradient(circle at 10% 20%, rgba(76, 175, 80, 0.2) 0%, transparent 20%), radial-gradient(circle at 90% 80%, rgba(46, 125, 50, 0.2) 0%, transparent 20%), linear-gradient(135deg, var(--color-primary), var(--color-primary-dark)); }
    #loginBox { background: var(--color-white); box-shadow: var(--shadow-xl); border-radius: var(--border-radius-xl); padding: 40px; width: 100%; max-width: 400px; text-align: center; animation: fadeIn 0.5s ease-out; position: relative; overflow: hidden; }
    #loginBox::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(to right, var(--color-primary), var(--color-accent)); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    #loginBox h2 { margin-bottom: 24px; color: var(--color-primary); font-weight: 600; font-size: 24px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .input-group { margin-bottom: 20px; text-align: left; position: relative; }
    .input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--color-text-light); font-size: 14px; transition: var(--transition); }
    #loginBox input { width: 100%; padding: 14px 16px; border-radius: var(--border-radius); border: 1px solid var(--color-border); font-size: 16px; outline: none; transition: var(--transition); background-color: #f8fafc; box-shadow: var(--shadow-sm); }
    #loginBox input:focus { border-color: var(--color-accent); box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2); background-color: var(--color-white); }
    #btnLogin { margin-top: 24px; width: 100%; padding: 16px; background: linear-gradient(to right, var(--color-primary), var(--color-accent)); color: var(--color-white); border: none; border-radius: var(--border-radius); font-weight: 600; font-size: 16px; cursor: pointer; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: var(--shadow-md); position: relative; overflow: hidden; }
    #btnLogin:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
    #loginMessage { color: var(--color-danger); min-height: 20px; margin-top: 16px; font-size: 14px; font-weight: 500; transition: var(--transition); }
    header { position: fixed; top: 0; left: 0; right: 0; height: 70px; background: linear-gradient(to right, var(--color-primary), var(--color-primary-dark)); color: var(--color-white); display: flex; align-items: center; justify-content: space-between; padding: 0 24px; box-shadow: var(--shadow-md); z-index: 1000; user-select: none; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
    header h1 { margin: 0; font-weight: 600; font-size: 20px; flex-grow: 1; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px; position: absolute; left: 50%; transform: translateX(-50%); }
    .menu-toggle { background: rgba(255, 255, 255, 0.1); border-radius: var(--border-radius); border: none; cursor: pointer; width: 48px; height: 48px; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 6px; z-index: 1100; transition: var(--transition); }
    .menu-toggle:hover { background: rgba(255, 255, 255, 0.2); }
    .menu-toggle div { height: 3px; width: 24px; background: var(--color-white); border-radius: 3px; transition: var(--transition); }
    .menu-toggle.open div:nth-child(1) { transform: translateY(9px) rotate(45deg); }
    .menu-toggle.open div:nth-child(2) { opacity: 0; }
    .menu-toggle.open div:nth-child(3) { transform: translateY(-9px) rotate(-45deg); }
    nav.menu { position: fixed; top: 0; bottom: 0; left: 0; width: 280px; background: linear-gradient(to bottom, var(--color-primary), var(--color-primary-dark)); overflow-x: hidden; overflow-y: auto; transform: translateX(-100%); transition: transform 0.3s ease; z-index: 1050; box-shadow: var(--shadow-lg); }
    nav.menu.open { transform: translateX(0); }
    .menu-content { width: 100%; }
    .submenu-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, var(--color-primary), var(--color-primary-dark)); transform: translateX(100%); transition: transform 0.3s ease; padding: 20px 0; }
    .submenu-content.active { transform: translateX(0); }
    .menu-btn, .excluir-btn, .submenu-btn, .submenu-back-btn { display: flex; align-items: center; gap: 16px; width: calc(100% - 20px); margin: 5px 10px; padding: 16px 20px; background: transparent; border: none; font-weight: 500; color: rgba(255,255,255,0.9); cursor: pointer; border-radius: var(--border-radius); font-size: 16px; transition: var(--transition); text-align: left; position: relative; }
    .menu-btn:hover, .submenu-btn:hover, .submenu-back-btn:hover { background: rgba(255,255,255,0.1); color: var(--color-white); }
    .menu-btn.active { background: rgba(255,255,255,0.2); }
    .menu-btn i, .submenu-btn i, .submenu-back-btn i { font-size: 20px; width: 24px; text-align: center; }
    .menu-btn .arrow { margin-left: auto; transition: transform 0.3s ease; font-size: 14px; }
    .submenu-back-btn { font-weight: 600; }
    main.content { margin-top: 70px; padding: 20px; transition: filter 0.3s ease; min-height: calc(100vh - 70px); }
    .mobile-menu-open main.content, .mobile-menu-open header { filter: blur(4px) brightness(0.7); }
    .tab-content { display: none; animation: fadeIn 0.3s ease-out; }
    .tab-content.active { display: block; }
    .card { background: var(--color-white); padding: 24px; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-sm); font-size: 16px; max-width: 1200px; margin: 0 auto 30px; border-left: 4px solid var(--color-accent); transition: var(--transition); }
    .card h2 { color: var(--color-primary); margin-bottom: 24px; font-weight: 600; font-size: 22px; display: flex; align-items: center; gap: 12px; }
    .card h2 i { color: var(--color-accent); }
    .card h3 { color: var(--color-primary-dark); margin-top: 25px; margin-bottom: 10px; border-bottom: 2px solid var(--color-border); padding-bottom: 5px; }
    label { display: block; margin-top: 16px; font-weight: 500; color: var(--color-text-light); font-size: 14px; }
    label.required::after { content: " *"; color: var(--color-danger); }
    input, select, textarea { width: 100%; padding: 12px 14px; margin-top: 8px; border-radius: var(--border-radius); border: 1px solid var(--color-border); font-size: 16px; transition: var(--transition); background-color: #f8fafc; box-shadow: var(--shadow-sm); font-family: var(--font-family); }
    textarea { resize: vertical; min-height: 80px; }
    input:focus, select:focus, textarea:focus { border-color: var(--color-accent); box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2); outline: none; background-color: var(--color-white); }
    .form-row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 16px; }
    .form-col { flex: 1; min-width: 200px; }
    button.save, .btn-secondary { margin-top: 24px; background: linear-gradient(to right, var(--color-primary), var(--color-accent)); color: var(--color-white); border: none; padding: 14px 24px; border-radius: var(--border-radius); font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: var(--shadow-sm); transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; max-width: 300px; }
    button.save:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .btn-secondary { background: linear-gradient(to right, #6c757d, #5a6268); }
    .resultado { margin-top: 24px; font-weight: 600; color: var(--color-primary); font-size: 16px; padding: 12px 16px; background-color: #e8f5e9; border-radius: var(--border-radius); border-left: 4px solid var(--color-accent); }
    .botoes-relatorio { margin-top: 32px; display: flex; gap: 16px; flex-wrap: wrap; }
    .botoes-relatorio button, .btn-ai { flex: 1; min-width: 200px; padding: 14px; font-weight: 600; font-size: 16px; border: none; border-radius: var(--border-radius); background: linear-gradient(to right, var(--color-primary), var(--color-accent)); color: var(--color-white); cursor: pointer; box-shadow: var(--shadow-sm); transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 10px; }
    .btn-ai { background: linear-gradient(to right, var(--color-ai), #9c27b0); }
    .btn-excluir { padding: 8px 12px; margin-left: 10px; border-radius: var(--border-radius); border: none; background-color: var(--color-danger); color: var(--color-white); cursor: pointer; font-weight: 500; font-size: 14px; transition: var(--transition); display: flex; align-items: center; gap: 6px; }
    .btn-excluir:hover { background-color: #c53030; transform: translateY(-1px); }
    #alertContainer { position: fixed; top: 20px; right: 20px; background-color: var(--color-success); color: #fff; padding: 16px 24px; border-radius: var(--border-radius); font-weight: 500; font-size: 15px; opacity: 0; pointer-events: none; transition: all 0.4s ease; transform: translateY(-20px); z-index: 2500; display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow-xl); max-width: 90%; }
    #alertContainer.error { background-color: var(--color-danger); } #alertContainer.warning { background-color: var(--color-warning); } #alertContainer.info { background-color: var(--color-info); }
    #alertContainer.show { opacity: 1; pointer-events: auto; transform: translateY(0); }
    
    /* User Menu in Header */
    #user-menu-container {
        position: relative;
        z-index: 1200;
    }
    #user-menu-toggle {
        background: rgba(255, 255, 255, 0.1);
        color: var(--color-white);
        padding: 8px;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(255,255,255,0.2);
        cursor: pointer;
        transition: var(--transition);
    }
    #user-menu-toggle:hover, #user-menu-toggle.open {
        background: rgba(255, 255, 255, 0.2);
    }
    #user-menu-toggle .fa-user-circle {
        font-size: 20px;
    }

    #user-menu-dropdown {
        position: absolute;
        top: calc(100% + 12px);
        right: 0;
        background: var(--color-white);
        color: var(--color-text);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
        width: 240px;
        overflow: hidden;
        transition: opacity 0.2s ease, transform 0.2s ease;
        transform-origin: top right;
        opacity: 0;
        transform: scale(0.95) translateY(-10px);
        pointer-events: none;
        display: block; /* Keep it block for animation */
    }
    #user-menu-dropdown.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
    }
    .user-menu-header {
        padding: 16px;
        background-color: #f8f9fa;
    }
    .user-menu-header p {
        margin: 0;
        line-height: 1.3;
    }
    .user-menu-header p strong {
        font-size: 12px;
        color: var(--color-text-light);
    }
    #userMenuUsername {
        font-weight: 600;
        color: var(--color-primary-dark);
        font-size: 16px;
        word-break: break-all;
    }
    .user-menu-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        font-size: 14px;
        color: var(--color-text-light);
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .user-menu-item:not(#logoutBtn):hover {
        background-color: #f1f5f9;
    }
    #logoutBtn {
        width: 100%;
        border: none;
        background: transparent;
        color: var(--color-danger);
        font-weight: 500;
        text-align: left;
    }
    #logoutBtn:hover {
        background-color: #fef2f2;
    }
    #user-menu-dropdown hr {
        border: none;
        border-top: 1px solid var(--color-border);
        margin: 0;
    }

    .chart-container { position: relative; height: 300px; margin-bottom: 40px; }
    .chart-title { text-align: center; margin-bottom: 15px; font-weight: 500; color: var(--color-primary); }
    .chart-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 30px; }
    .permission-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; margin-top: 15px; }
    .permission-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: #edf2f7; border-radius: var(--border-radius); font-size: 14px; cursor: pointer; }
    .user-card { padding: 15px; border-bottom: 1px solid var(--color-border); transition: var(--transition); border-radius: var(--border-radius); }
    .user-card:hover { background: #f8fafc; } .user-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; } .user-title { font-weight: 500; }
    .fazenda-list { margin-top: 20px; border: 1px solid var(--color-border); border-radius: var(--border-radius); overflow: hidden; }
    .fazenda-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--color-border); flex-wrap: wrap; gap: 10px; }
    .plano-card { background: #f8fafc; border-radius: var(--border-radius); padding: 16px; margin-bottom: 16px; border-left: 5px solid var(--color-info); transition: var(--transition); }
    .plano-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 10px;}
    .plano-title { font-weight: 600; color: var(--color-primary); } .plano-title i { margin-right: 8px; }
    .plano-status { font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 20px; color: white; text-transform: uppercase; }
    .plano-status.pendente { background-color: var(--color-info); } .plano-status.concluído { background-color: var(--color-success); } .plano-status.atrasado { background-color: var(--color-danger); }
    .plano-details { font-size: 14px; color: var(--color-text-light); display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; }
    .plano-details > div { display: flex; align-items: center; gap: 8px; } .plano-details i { color: var(--color-accent); width: 16px; text-align: center; }
    .plano-actions { margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; }
    #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); z-index: 2000; display: none; justify-content: center; align-items: center; flex-direction: column; gap: 20px; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); }
    .spinner { border: 8px solid #f3f3f3; border-top: 8px solid var(--color-ai); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #ai-analysis-card { background: linear-gradient(135deg, #f3e5f5, #e1bee7); border-left-color: var(--color-ai); padding: 20px; margin-top: 20px; border-radius: var(--border-radius); display: none; }
    #ai-analysis-card h3 { color: var(--color-ai); } #ai-analysis-card p { white-space: pre-wrap; }
    #harvestPlanTable { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
    #harvestPlanTable th, #harvestPlanTable td { padding: 10px; text-align: left; border-bottom: 1px solid var(--color-border); }
    #harvestPlanTable th { background-color: #f8f9fa; font-weight: 600; }
    #harvestPlanTable tbody tr { cursor: grab; }
    #harvestPlanTable tbody tr:active { cursor: grabbing; background: #e9ecef; }
    #harvestPlanTable .talhao-list-cell { font-size: 12px; max-width: 150px; word-wrap: break-word; }
    .harvest-summary { margin-top: 20px; padding: 15px; background: var(--color-bg); border-radius: var(--border-radius); border-top: 3px solid var(--color-primary); }
    .harvest-summary p { margin: 5px 0; font-weight: 500; }
    .harvest-summary span { font-weight: 600; color: var(--color-primary-dark); }
    
    /* --- NEW/FINAL TALHAO SELECTION STYLES --- */
    .talhao-selection-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        padding: 10px;
        margin-top: 10px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 10px;
        background-color: #f8fafc;
    }

    .talhao-selection-item {
        display: grid;
        grid-template-columns: auto 1fr; /* Coluna para o checkbox e outra para o conteúdo */
        grid-template-rows: auto 1fr;    /* Linha para o nome e outra para os detalhes */
        grid-template-areas:
            "check name"
            "check details";
        gap: 4px 12px; /* Espaçamento entre linhas e colunas */
        padding: 12px;
        border-radius: var(--border-radius);
        background-color: var(--color-white);
        border: 1px solid var(--color-border);
        box-shadow: var(--shadow-sm);
        transition: var(--transition);
        cursor: pointer;
    }

    .talhao-selection-item:hover {
        border-color: var(--color-primary);
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .talhao-selection-item input[type="checkbox"] {
        grid-area: check;
        align-self: start;
        margin-top: 4px;
        transform: scale(1.2);
        pointer-events: none; /* Deixa o label controlar o clique */
    }

    .talhao-name {
        grid-area: name;
        font-weight: 600;
        color: var(--color-primary-dark);
        line-height: 1.3;
        word-break: break-word; /* Força a quebra de palavras longas */
    }

    .talhao-details {
        grid-area: details;
        display: flex;
        flex-direction: column;
        gap: 5px;
        font-size: 13px;
        color: var(--color-text-light);
    }

    .talhao-details span {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .talhao-details i {
        width: 14px;
        text-align: center;
        color: var(--color-accent);
        flex-shrink: 0;
    }
    /* --- END OF NEW/FINAL TALHAO SELECTION STYLES --- */

    #harvest-plans-list .plano-card { border-left-color: var(--color-success); }
    .editable-atr { cursor: pointer; background-color: #eef7ee; padding: 2px 6px; border-radius: 6px; font-weight: 500;}
    .editable-atr:hover { background-color: #d8f0d8; }
    .info-display { font-size: 14px; color: var(--color-primary); font-weight: 500; height: 20px; margin-top: 5px;}
    .upload-area { border: 2px dashed var(--color-border); border-radius: var(--border-radius); padding: 2rem; text-align: center; cursor: pointer; transition: var(--transition); }
    .upload-area:hover { border-color: var(--color-primary); background-color: #e8f5e9; }
    #logoPreview { max-width: 150px; max-height: 80px; margin-top: 15px; border-radius: var(--border-radius); }
    
    .card-header-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
    }
    .card-header-actions .button-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .card-header-actions .button-group button {
        margin-top: 0;  
        width: auto;
        max-width: none;
        flex-shrink: 0;
    }
    
    /* MODAL STYLES */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 2000;
        display: none;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
    }
    .modal-overlay.show { display: flex; }
    .modal-content {
        background: var(--color-white);
        padding: 30px;
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-xl);
        width: 90%;
        max-width: 700px;
        max-height: 90vh;
        overflow-y: auto;
        animation: fadeIn 0.3s ease-out;
    }
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid var(--color-border);
    }
    .modal-header h2 { margin: 0; color: var(--color-primary); }
    .modal-close-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--color-text-light);
        transition: var(--transition);
    }
    .modal-close-btn:hover { color: var(--color-danger); transform: rotate(90deg); }
    .modal-footer {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid var(--color-border);
        display: flex;
        justify-content: flex-end;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }
    .modal-footer .danger-zone { margin-right: auto; display: flex; gap: 10px; }
    .modal-footer button { margin-top: 0; }
    #confirmationModal .modal-content { max-width: 450px; }
    #confirmationModal p { color: var(--color-text-secondary); line-height: 1.6; }


    @media (max-width: 768px) {
        header h1 { font-size: 16px; max-width: calc(100% - 180px); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card { padding: 16px; }
        #harvestPlanTable th, #harvestPlanTable td { padding: 8px; font-size: 12px; }
        .card-header-actions {
            flex-direction: column;
            align-items: stretch;
        }
        .card-header-actions .button-group {
            justify-content: center;
        }
    }
    </style>
</head>
<body>

    <div id="loading-overlay">
    <div class="spinner"></div>
    <p style="color: var(--color-ai); font-weight: 500;">Analisando dados com a IA...</p>
    </div>

    <div id="loginScreen">
    <div id="loginBox" role="main" aria-label="Tela de login">
        <h2><i class="fas fa-sign-in-alt"></i> BEM VINDO</h2>
        <div class="input-group">
            <label for="loginUser">Utilizador</label>
            <input id="loginUser" placeholder="Digite o seu utilizador" aria-label="Campo utilizador" value="admin"/>
        </div>
        <div class="input-group">
            <label for="loginPass">Senha</label>
            <input id="loginPass" type="password" placeholder="Digite a sua senha" aria-label="Campo senha" value="admin123"/>
        </div>
        <button id="btnLogin" aria-label="Botão de login"><i class="fas fa-sign-in-alt"></i> LOGIN</button>
        <div id="loginMessage" role="alert" aria-live="assertive"></div>
        <div id="debugInfo" style="font-size: 12px; color: #888; margin-top: 10px; min-height: 1.2em;"></div>
    </div>
    </div>

    <div id="appScreen" style="display:none; flex:1; flex-direction: column;">

    <header>
        <button class="menu-toggle" id="btnToggleMenu" aria-label="Abrir menu" aria-expanded="false" aria-controls="menu">
            <div></div><div></div><div></div>
        </button>
        <h1><i class="fas fa-leaf"></i> Inspeção de Cana</h1>
        
        <div id="user-menu-container" style="display:none;">
            <button id="user-menu-toggle" aria-label="Menu do Utilizador" aria-haspopup="true" aria-expanded="false">
                <i class="fas fa-user-circle"></i>
            </button>
            <div id="user-menu-dropdown" role="menu">
                <div class="user-menu-header">
                    <p><strong>Conectado como:</strong></p>
                    <p id="userMenuUsername"></p>
                </div>
                <div id="currentDateTime" class="user-menu-item"></div>
                <hr>
                <button id="changePasswordBtn" role="menuitem" class="user-menu-item">
                    <i class="fas fa-key"></i> Alterar Senha
                </button>
                <button id="logoutBtn" role="menuitem" class="user-menu-item">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </div>

    </header>

    <nav class="menu" id="menu" aria-label="Menu Principal" tabindex="-1"></nav>

    <main class="content" id="content">
        <section id="dashboard" class="tab-content card" aria-label="Dashboard" tabindex="0" hidden>
            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px;">
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                <button id="btnAnalisarDashboard" class="btn-ai" style="min-width: auto; padding: 12px 20px;">✨ Gerar Análise com IA</button>
            </div>
            <div id="ai-analysis-card">
                <h3><i class="fas fa-magic-wand-sparkles"></i> Análise da IA</h3>
                <p id="ai-analysis-content"></p>
            </div>
            <div class="chart-grid">
            <div>
                <h3 class="chart-title">Média de Brocamento por Fazenda</h3>
                <div class="chart-container"><canvas id="graficoBrocamento"></canvas></div>
            </div>
            <div>
                <h3 class="chart-title">Distribuição de Brocamento</h3>
                <div class="chart-container"><canvas id="graficoBrocamentoPizza"></canvas></div>
            </div>
            <div>
                <h3 class="chart-title">Evolução de Brocamento</h3>
                <div class="chart-container"><canvas id="graficoBrocamentoLinha"></canvas></div>
            </div>
            <div>
                <h3 class="chart-title">Média de Perda por Fazenda</h3>
                <div class="chart-container"><canvas id="graficoPerda"></canvas></div>
            </div>
            <div>
                <h3 class="chart-title">Tipos de Perda</h3>
                <div class="chart-container"><canvas id="graficoPerdaRadar"></canvas></div>
            </div>
            <div>
                <h3 class="chart-title">Evolução de Perda</h3>
                <div class="chart-container"><canvas id="graficoPerdaLinha"></canvas></div>
            </div>
            </div>
        </section>

        <section id="planejamentoColheita" class="tab-content card" aria-label="Planeamento de Colheita" tabindex="0" hidden>
            <div class="card-header-actions">
                <h2 style="color: var(--color-success); margin: 0;"><i class="fas fa-tractor"></i> Planeamento de Colheita</h2>
                <div class="button-group">
                    <button id="btnGeneralHarvestReportPDF" class="btn-secondary" style="background: var(--color-danger);"><i class="fas fa-file-pdf"></i> Relatório PDF Geral</button>
                    <button id="btnGeneralHarvestReportExcel" class="btn-secondary" style="background: var(--color-primary-dark);"><i class="fas fa-file-excel"></i> Relatório Excel Geral</button>
                    <button id="btnAddNewHarvestPlan" class="save"><i class="fas fa-plus"></i> Novo Plano</button>
                </div>
            </div>

            <div id="harvest-plans-list-container">
                <h3 style="margin-top: 30px;"><i class="fas fa-stream"></i> Planos Guardados</h3>
                <div id="harvest-plans-list"></div>
            </div>
            
            <div id="harvest-plan-editor" style="display: none;">
                <div class="card" style="border-left-color: var(--color-success); margin-top:20px;">
                    <h3><i class="fas fa-cogs"></i> Configurações da Frente de Colheita</h3>
                    <div class="form-row">
                        <div class="form-col"><label for="harvestFrontName" class="required">Nome da Frente:</label><input type="text" id="harvestFrontName" placeholder="Ex: Frente 01" required></div>
                        <div class="form-col"><label for="harvestStartDate" class="required">Data de Início:</label><input type="date" id="harvestStartDate" required></div>
                        <div class="form-col"><label for="harvestDailyRate" class="required">Média Toneladas/Dia:</label><input type="number" id="harvestDailyRate" value="750" required></div>
                    </div>
                </div>

                <div class="card" style="border-left-color: var(--color-success);">
                    <h3 id="addOrEditSequenceTitle"><i class="fas fa-plus-circle"></i> Adicionar Fazenda à Sequência</h3>
                    <input type="hidden" id="editingGroupId">
                    <div class="form-row">
                        <div class="form-col" style="flex-grow: 2;"><label for="harvestFazenda" class="required">Fazenda:</label><select id="harvestFazenda" required></select></div>
                        <div class="form-col"><label for="harvestAtr" class="required">ATR Previsto:</label><input type="number" id="harvestAtr" placeholder="Ex: 130.5"></div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <label for="harvestMaturador">Maturador Aplicado:</label>
                            <input type="text" id="harvestMaturador" placeholder="Nome do produto">
                        </div>
                        <div class="form-col">
                            <label for="harvestMaturadorDate">Data de Aplicação:</label>
                            <input type="date" id="harvestMaturadorDate">
                        </div>
                    </div>
                    
                    <div id="harvestTalhaoSelectionContainer">
                        <label>Talhões Disponíveis:</label>
                        <div id="harvestTalhaoSelectionList" class="talhao-selection-list"></div>
                    </div>
                    <div class="form-row">
                        <button class="save" id="btnAddOrUpdateHarvestSequence" style="max-width: 300px;"><i class="fas fa-plus"></i> Adicionar à Sequência</button>
                        <button id="btnCancelEditSequence" class="btn-secondary" style="max-width: 200px; display: none;"><i class="fas fa-times"></i> Cancelar Edição</button>
                        <button id="btnOptimizeHarvest" class="btn-ai" style="max-width: 300px; margin-top: 24px;">✨ Otimizar Sequência com IA</button>
                    </div>
                </div>

                <h3><i class="fas fa-stream"></i> Sequência de Colheita</h3>
                <div class="table-responsive">
                    <table id="harvestPlanTable">
                        <thead>
                            <tr>
                                <th>Seq.</th>
                                <th>Fazenda</th>
                                <th>Talhões</th>
                                <th>Área (ha)</th>
                                <th>Produção (ton)</th>
                                <th>ATR</th>
                                <th>Idade (meses)</th>
                                <th>Entrada</th>
                                <th>Saída</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="harvestSummary" class="harvest-summary"></div>
                <div style="display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap;">
                    <button id="btnSaveHarvestPlan" class="save"><i class="fas fa-save"></i> Guardar Plano</button>
                    <button id="btnCancelHarvestPlan" class="btn-secondary" style="margin-top: 24px;"><i class="fas fa-times"></i> Voltar para a Lista</button>
                </div>
            </div>
        </section>

        <section id="planejamento" class="tab-content card" aria-label="Planeamento de Inspeções" tabindex="0" hidden>
            <h2 style="color: var(--color-info);"><i class="fas fa-calendar-alt"></i> Planeamento de Inspeções</h2>
            <div class="card" style="border-left-color: var(--color-info);">
                <h3><i class="fas fa-plus-circle"></i> Agendar Nova Inspeção</h3>
                <div class="form-row">
                    <div class="form-col"><label for="planoTipo" class="required">Tipo de Inspeção:</label><select id="planoTipo" required><option value="broca">Brocamento</option><option value="perda">Perda na Colheita</option></select></div>
                    <div class="form-col"><label for="planoFazenda" class="required">Fazenda:</label><select id="planoFazenda" required></select></div>
                </div>
                <div class="form-row">
                    <div class="form-col"><label for="planoTalhao" class="required">Talhão:</label><input type="text" id="planoTalhao" placeholder="Ex: T-23A" required></div>
                    <div class="form-col"><label for="planoData" class="required">Data Prevista:</label><input type="date" id="planoData" required></div>
                </div>
                <div class="form-row">
                    <div class="form-col"><label for="planoResponsavel" class="required">Responsável:</label><select id="planoResponsavel" required></select></div>
                    <div class="form-col"><label for="planoMeta">Meta (Opcional):</label><input type="number" id="planoMeta" placeholder="Ex: 2 (% broca) ou 500 (kg perda)"></div>
                </div>
                <label for="planoObs">Observações:</label>
                <textarea id="planoObs" placeholder="Detalhes adicionais sobre o planeamento..."></textarea>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="save" id="btnAgendarInspecao" style="max-width: 300px; background: linear-gradient(to right, var(--color-info), #42a5f5);"><i class="fas fa-calendar-check"></i> Agendar Inspeção</button>
                    <button id="btnSugerirPlano" class="btn-ai" style="max-width: 300px; margin-top: 24px;">✨ Obter Sugestões da IA</button>
                </div>
            </div>
            <h3><i class="fas fa-tasks"></i> Inspeções Agendadas</h3>
            <div id="listaPlanejamento"></div>
        </section>

        <section id="lancamentoBroca" class="tab-content card" aria-label="Lançamento Broca" tabindex="0" hidden>
            <h2><i class="fas fa-bug"></i> Lançamento Broca</h2>
            <div class="form-row">
                <div class="form-col">
                    <label for="codigo" class="required">Código da Fazenda:</label>
                    <input type="number" id="codigo" aria-describedby="fazendaNome" placeholder="Selecione ou digite o código" required />
                    <div id="fazendaNome" class="info-display"></div>
                </div>
                <div class="form-col">
                    <label for="data" class="required">Data da Inspeção:</label>
                    <input type="date" id="data" required />
                </div>
            </div>
            <div class="form-row">
                <div class="form-col">
                        <label for="talhao" class="required">Talhão:</label>
                        <input type="text" id="talhao" placeholder="Ex: T12, T15-A" required />
                        <div id="varietyDisplay" class="info-display"></div>
                </div>
                    <div class="form-col">
                    <label for="entrenos" class="required">Entrenós Contados:</label>
                    <input type="number" id="entrenos" min="1" placeholder="0" required />
                </div>
            </div>
                <div class="form-row">
                <div class="form-col"><label for="brocaBase" class="required">Brocado Base:</label><input type="number" id="brocaBase" min="0" value="0" required /></div>
                <div class="form-col"><label for="brocaMeio" class="required">Brocado Meio:</label><input type="number" id="brocaMeio" min="0" value="0" required /></div>
                <div class="form-col"><label for="brocaTopo" class="required">Brocado Topo:</label><input type="number" id="brocaTopo" min="0" value="0" required /></div>
            </div>
            <div class="form-row">
                <div class="form-col">
                    <label for="brocado">Total de Brocado (Automático):</label>
                    <input type="number" id="brocado" min="0" placeholder="0" readonly style="background-color: #e9ecef;" />
                </div>
            </div>
            <div class="resultado" id="resultado"></div>
            <button class="save" type="button" id="btnSalvarBrocamento"><i class="fas fa-save"></i> Guardar Inspeção</button>
        </section>
        
        <section id="relatorioBroca" class="tab-content card" aria-label="Relatório Broca" tabindex="0" hidden>
            <h2><i class="fas fa-chart-bar"></i> Relatório de Inspeção de Cana (Brocamento)</h2>
            <div class="form-row">
                <div class="form-col"><label for="fazendaFiltroBrocamento">Filtrar por Fazenda:</label><select id="fazendaFiltroBrocamento"><option value="">Todas</option></select></div>
                <div class="form-col"><label for="inicioBrocamento" class="required">Data Início:</label><input type="date" id="inicioBrocamento" /></div>
                <div class="form-col"><label for="fimBrocamento" class="required">Data Fim:</label><input type="date" id="fimBrocamento" /></div>
            </div>
                <div class="form-row">
                <div class="form-col">
                    <label for="tipoRelatorioBroca">Tipo de Relatório:</label>
                    <select id="tipoRelatorioBroca">
                        <option value="A">Modelo A - Geral</option>
                        <option value="B">Modelo B - Por Fazenda</option>
                    </select>
                </div>
            </div>
            <div class="botoes-relatorio">
                <button id="btnPDFBrocamento" type="button"><i class="fas fa-file-pdf"></i> Gerar Relatório (PDF)</button>
                <button id="btnExcelBrocamento" type="button"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
            </div>
        </section>

        <section id="lancamentoPerda" class="tab-content card" aria-label="Lançamento Perda" tabindex="0" hidden>
            <h2><i class="fas fa-dollar-sign"></i> Lançamento Perda</h2>
            <div class="form-row">
                <div class="form-col"><label for="dataPerda" class="required">Data:</label><input type="date" id="dataPerda" required /></div>
                <div class="form-col"><label for="codigoPerda" class="required">Código da Fazenda:</label><input type="number" id="codigoPerda" aria-describedby="fazendaNomePerda" placeholder="Selecione ou digite o código" required /><div id="fazendaNomePerda" class="info-display"></div></div>
            </div>
            <div class="form-row">
                <div class="form-col"><label for="talhaoPerda" class="required">Talhão:</label><input type="text" id="talhaoPerda" placeholder="Ex: T12, T15-A" required /><div id="varietyDisplayPerda" class="info-display"></div></div>
                <div class="form-col"><label for="frenteServico" class="required">Frente de Serviço:</label><input type="text" id="frenteServico" placeholder="Ex: Frente 1" required /></div>
                <div class="form-col"><label for="turno" class="required">Turno:</label><select id="turno" required><option value="A">A</option><option value="B">B</option><option value="C">C</option></select></div>
            </div>
            <div class="form-row">
                <div class="form-col"><label for="frotaEquipamento" class="required">Frota do Equipamento:</label><input type="text" id="frotaEquipamento" placeholder="Ex: 7501" required /></div>
                <div class="form-col"><label for="matriculaOperador" class="required">Matrícula do Operador:</label><input type="number" id="matriculaOperador" placeholder="Digite a matrícula" required /><div id="operadorNome" class="info-display"></div></div>
            </div>
            <h3>Tipos de Perda (kg)</h3>
            <div class="form-row">
                <div class="form-col"><label for="canaInteira">Cana Inteira:</label><input type="number" id="canaInteira" min="0" placeholder="0" /></div>
                <div class="form-col"><label for="tolete">Tolete:</label><input type="number" id="tolete" min="0" placeholder="0" /></div>
                <div class="form-col"><label for="toco">Toco:</label><input type="number" id="toco" min="0" placeholder="0" /></div>
            </div>
            <div class="form-row">
                <div class="form-col"><label for="ponta">Ponta:</label><input type="number" id="ponta" min="0" placeholder="0" /></div>
                <div class="form-col"><label for="estilhaco">Estilhaço:</label><input type="number" id="estilhaco" min="0" placeholder="0" /></div>
                <div class="form-col"><label for="pedaco">Pedaço:</label><input type="number" id="pedaco" min="0" placeholder="0" /></div>
            </div>
            <div class="resultado" id="resultadoPerda"></div>
            <button class="save" type="button" id="btnSalvarPerda"><i class="fas fa-save"></i> Guardar Perda de Cana</button>
        </section>

        <section id="relatorioPerda" class="tab-content card" aria-label="Relatório Perda" tabindex="0" hidden>
            <h2><i class="fas fa-chart-pie"></i> Relatório de Perda de Cana</h2>
            <div class="form-row">
                <div class="form-col"><label for="fazendaFiltroPerda">Filtrar por Fazenda:</label><select id="fazendaFiltroPerda"><option value="">Todas</option></select></div>
                <div class="form-col"><label for="talhaoFiltroPerda">Filtrar por Talhão:</label><input type="text" id="talhaoFiltroPerda" placeholder="Digite Talhão" /></div>
                <div class="form-col"><label for="operadorFiltroPerda">Filtrar por Operador:</label><select id="operadorFiltroPerda"><option value="">Todos</option></select></div>
            </div>
            <div class="form-row">
                <div class="form-col"><label for="frenteFiltroPerda">Filtrar por Frente de Serviço:</label><input type="text" id="frenteFiltroPerda" placeholder="Digite Frente de Serviço" /></div>
                <div class="form-col"><label for="inicioPerda" class="required">Data Início:</label><input type="date" id="inicioPerda" /></div>
                <div class="form-col"><label for="fimPerda" class="required">Data Fim:</label><input type="date"id="fimPerda" /></div>
            </div>
            <div class="form-row"><div class="form-col"><label for="tipoRelatorioPerda">Tipo de Relatório:</label><select id="tipoRelatorioPerda"><option value="A">Modelo A - Resumido</option><option value="B">Modelo B - Detalhado</option></select></div></div>
            <div class="botoes-relatorio">
                <button id="btnPDFPerda" type="button"><i class="fas fa-file-pdf"></i> Gerar Relatório (PDF)</button>
                <button id="btnExcelPerda" type="button"><i class="fas fa-file-excel"></i> Exportar para Excel</button>
            </div>
        </section>

        <section id="excluirDados" class="tab-content card" aria-label="Excluir Lançamentos" tabindex="0" hidden>
            <h2><i class="fas fa-trash"></i> Excluir Lançamentos</h2>
            <p>Selecione um lançamento para excluir. Esta ação é irreversível.</p>
            <div id="listaExclusao" tabindex="0"></div>
        </section>

        <section id="cadastros" class="tab-content card" aria-label="Cadastros" tabindex="0" hidden>
            <h2><i class="fas fa-book"></i> Cadastros Gerais</h2>

            <div class="card" style="border-left-color: var(--color-purple);">
                <h3><i class="fas fa-upload"></i> Importar Cadastros via CSV</h3>
                <p>Faça o upload de um ficheiro CSV com todos os dados de fazendas e talhões. O sistema irá <strong>atualizar</strong> os cadastros existentes e <strong>adicionar</strong> novos, sem criar duplicatas.</p>
                <div class="upload-area" id="csvUploadArea">
                    <i class="fas fa-file-csv fa-2x" style="color: var(--color-primary);"></i>
                    <p>Clique ou arraste um ficheiro CSV aqui</p>
                </div>
                <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                <button id="btnDownloadCsvTemplate" class="save" style="max-width: 300px; margin-top: 15px; background: var(--color-info);"><i class="fas fa-download"></i> Baixar Modelo CSV</button>
                <small>Formato esperado: Cód;FAZENDA;TALHÃO;Área;Produção;Variedade;Corte;Distancia;DataUltimaColheita</small>
            </div>

            <div class="card" style="border-left-color: var(--color-purple); margin-top: 30px;">
                <h3><i class="fas fa-tractor"></i> Gerir Fazendas e Talhões (Manual)</h3>
                <div class="form-row">
                    <div class="form-col"><label for="farmCode" class="required">Código da Fazenda:</label><input type="number" id="farmCode" placeholder="Ex: 4012"></div>
                    <div class="form-col"><label for="farmName" class="required">Nome da Fazenda:</label><input type="text" id="farmName" placeholder="Ex: FAZ. LAGOA CERCADA"></div>
                </div>
                <button id="btnSaveFarm" class="save" style="max-width: 250px;"><i class="fas fa-plus-circle"></i> Guardar Fazenda</button>
                <hr style="margin: 20px 0;">
                <label for="farmSelect">Selecione uma Fazenda para gerir os seus talhões:</label>
                <select id="farmSelect"></select>
                <div id="talhaoManagementContainer" style="display:none;">
                    <h4>Talhões da Fazenda <span id="selectedFarmName"></span></h4>
                    <div id="talhaoList"></div>
                    <h5 style="margin-top:20px;">Adicionar/Editar Talhão</h5>
                    <input type="hidden" id="talhaoId">
                    <div class="form-row">
                        <div class="form-col"><label for="talhaoName" class="required">Nome do Talhão:</label><input type="text" id="talhaoName"></div>
                        <div class="form-col"><label for="talhaoArea" class="required">Área (ha):</label><input type="number" id="talhaoArea"></div>
                        <div class="form-col"><label for="talhaoProducao" class="required">Produção (ton):</label><input type="number" id="talhaoProducao"></div>
                            <div class="form-col"><label for="talhaoCorte">Corte:</label><input type="number" id="talhaoCorte" min="1" placeholder="Ex: 1"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-col"><label for="talhaoVariedade">Variedade:</label><input type="text" id="talhaoVariedade"></div>
                        <div class="form-col"><label for="talhaoDistancia">Distância (km):</label><input type="number" id="talhaoDistancia"></div>
                        <div class="form-col"><label for="talhaoUltimaColheita">Data da Última Colheita:</label><input type="date" id="talhaoUltimaColheita"></div>
                    </div>
                    <button id="btnSaveTalhao" class="save" style="max-width: 250px;"><i class="fas fa-save"></i> Guardar Talhão</button>
                </div>
            </div>
        </section>

        <section id="gerenciarUsuarios" class="tab-content card" aria-label="Gerir Utilizadores" tabindex="0" hidden>
            <h2><i class="fas fa-users-cog"></i> Gerir Utilizadores</h2>
            <h3><i class="fas fa-user-plus"></i> Criar Novo Utilizador</h3>
            <div class="form-row">
                <div class="form-col"><label for="newUserUsername" class="required">Nome do Utilizador:</label><input id="newUserUsername" type="text" required /></div>
                <div class="form-col"><label for="newUserPassword" class="required">Senha:</label><input id="newUserPassword" type="password" required /></div>
                <div class="form-col"><label for="newUserRole">Perfil:</label><select id="newUserRole"><option value="user">Utilizador</option><option value="admin">Administrador</option><option value="supervisor">Supervisor</option><option value="tecnico">Técnico</option><option value="colaborador">Colaborador</option></select></div>
            </div>
            <fieldset style="margin-top: 20px; border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: 15px;">
                <legend>Permissões</legend>
                <div class="permission-grid">
                    <label class="permission-item"><input type="checkbox" id="permDashboard" /> <i class="fas fa-tachometer-alt"></i> Dashboard</label>
                    <label class="permission-item"><input type="checkbox" id="permPlanejamentoColheita" /> <i class="fas fa-tractor"></i> Plan. Colheita</label>
                    <label class="permission-item"><input type="checkbox" id="permPlanejamento" /> <i class="fas fa-calendar-alt"></i> Plan. Inspeção</label>
                    <label class="permission-item"><input type="checkbox" id="permLancamentoBroca" /> <i class="fas fa-bug"></i> Lanç. Broca</label>
                    <label class="permission-item"><input type="checkbox" id="permLancamentoPerda" /> <i class="fas fa-dollar-sign"></i> Lanç. Perda</label>
                    <label class="permission-item"><input type="checkbox" id="permRelatorioBroca" /> <i class="fas fa-chart-bar"></i> Relatório Broca</label>
                    <label class="permission-item"><input type="checkbox" id="permRelatorioPerda" /> <i class="fas fa-chart-pie"></i> Relatório Perda</label>
                    <label class="permission-item"><input type="checkbox" id="permExcluir" /> <i class="fas fa-trash"></i> Excluir Dados</label>
                    <label class="permission-item"><input type="checkbox" id="permGerenciarUsuarios" /> <i class="fas fa-users-cog"></i> Gerir Utilizadores</label>
                    <label class="permission-item"><input type="checkbox" id="permConfiguracoes" /> <i class="fas fa-cog"></i> Cadastros</label>
                    <label class="permission-item"><input type="checkbox" id="permCadastrarPessoas" /> <i class="fas fa-id-card"></i> Cadastrar Pessoas</label>
                </div>
            </fieldset>
            <button class="save" id="btnCreateUser" style="max-width: 250px; margin-top: 25px;"><i class="fas fa-user-plus"></i> Criar Utilizador</button>
            <h3><i class="fas fa-users"></i> Utilizadores Cadastrados</h3>
            <div id="usersList" style="margin-top: 15px;"></div>
        </section>

        <section id="cadastrarPessoas" class="tab-content card" aria-label="Cadastrar Pessoas" tabindex="0" hidden>
            <h2><i class="fas fa-id-card"></i> Cadastro de Pessoas</h2>
            <div class="card" style="border-left-color: var(--color-purple);">
                <h3><i class="fas fa-upload"></i> Importar Pessoas via CSV</h3>
                <p>Faça o upload de um ficheiro CSV com matrículas e nomes. O sistema irá <strong>atualizar</strong> os nomes existentes e <strong>adicionar</strong> novos, sem criar duplicatas.</p>
                <div class="upload-area" id="personnelCsvUploadArea">
                    <i class="fas fa-file-csv fa-2x" style="color: var(--color-info);"></i>
                    <p>Clique ou arraste um ficheiro CSV aqui</p>
                </div>
                <input type="file" id="personnelCsvInput" accept=".csv" style="display: none;">
                <button id="btnDownloadPersonnelCsvTemplate" class="save" style="max-width: 300px; margin-top: 15px; background: var(--color-info);"><i class="fas fa-download"></i> Baixar Modelo CSV</button>
                <small>Formato esperado: Matricula;Nome</small> 
            </div>
            <div class="card" style="border-left-color: var(--color-info); margin-top: 30px;">
                <h3><i class="fas fa-user-plus"></i> Adicionar/Editar Pessoa (Manual)</h3>
                <input type="hidden" id="personnelId">
                <div class="form-row">
                    <div class="form-col"><label for="personnelMatricula" class="required">Matrícula:</label><input type="number" id="personnelMatricula" placeholder="Ex: 102030"></div>
                    <div class="form-col"><label for="personnelName" class="required">Nome Completo:</label><input type="text" id="personnelName" placeholder="Ex: João da Silva"></div>
                </div>
                <button id="btnSavePersonnel" class="save" style="max-width: 250px;"><i class="fas fa-save"></i> Guardar Pessoa</button>
            </div>
                <h3><i class="fas fa-users"></i> Pessoas Cadastradas</h3>
            <div id="personnelList" style="margin-top: 15px;"></div>
        </section>
        
        <section id="configuracoesEmpresa" class="tab-content card" aria-label="Configurações da Empresa" tabindex="0" hidden>
            <h2><i class="fas fa-building"></i> Configurações da Empresa</h2>
            <div class="card" style="border-left-color: var(--color-purple);">
                <h3><i class="fas fa-image"></i> Logotipo da Empresa</h3>
                <p>Faça o upload do logotipo que aparecerá no cabeçalho dos relatórios. Use uma imagem com fundo transparente (PNG) para melhores resultados.</p>
                <div class="upload-area" id="logoUploadArea">
                    <i class="fas fa-upload fa-2x" style="color: var(--color-primary);"></i>
                    <p>Clique ou arraste o logotipo aqui</p>
                    <img id="logoPreview" src="#" alt="Pré-visualização do Logo" style="display: none;" />
                </div>
                <input type="file" id="logoInput" accept="image/png, image/jpeg" style="display: none;">
                <button id="removeLogoBtn" class="btn-secondary" style="background: var(--color-danger); max-width: 200px; display: none;"><i class="fas fa-trash"></i> Remover Logo</button>
            </div>
        </section>

    </main>

    <div id="alertContainer" role="alert" aria-live="assertive"></div>
    </div>

    <div id="userEditModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="userEditModalTitle">Editar Utilizador</h2>
                <button id="userEditModalCloseBtn" class="modal-close-btn">&times;</button>
            </div>
            <input type="hidden" id="editingUserId">
            <div class="form-row">
                <div class="form-col">
                    <label for="editUserUsername">Nome do Utilizador:</label>
                    <input id="editUserUsername" type="text" disabled style="background: #eee;" />
                </div>
                <div class="form-col">
                    <label for="editUserRole">Perfil:</label>
                    <select id="editUserRole">
                        <option value="user">Utilizador</option>
                        <option value="admin">Administrador</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="tecnico">Técnico</option>
                        <option value="colaborador">Colaborador</option>
                    </select>
                </div>
            </div>
            <fieldset style="margin-top: 20px; border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: 15px;">
                <legend>Permissões</legend>
                <div id="editUserPermissionGrid" class="permission-grid">
                    </div>
            </fieldset>
            <div class="modal-footer">
                <div class="danger-zone">
                        <button id="btnResetPassword" class="btn-secondary" style="background: var(--color-warning);"><i class="fas fa-key"></i> Redefinir Senha</button>
                        <button id="btnDeleteUser" class="btn-secondary" style="background: var(--color-danger);"><i class="fas fa-trash"></i> Excluir Utilizador</button>
                </div>
                <button id="btnSaveUserChanges" class="save"><i class="fas fa-save"></i> Guardar Alterações</button>
            </div>
        </div>
    </div>
    
    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="confirmationModalTitle">Confirmar Ação</h2>
                    <button id="confirmationModalCloseBtn" class="modal-close-btn">&times;</button>
            </div>
            <p id="confirmationModalMessage">Tem a certeza que deseja guardar este lançamento?</p>
            <div class="modal-footer">
                <button id="confirmationModalCancelBtn" class="btn-secondary">Cancelar</button>
                <button id="confirmationModalConfirmBtn" class="save">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="changePasswordModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h2>Alterar Senha</h2>
                <button id="changePasswordModalCloseBtn" class="modal-close-btn">&times;</button>
            </div>
            <div class="input-group">
                <label for="currentPassword">Senha Atual:</label>
                <input type="password" id="currentPassword" required>
            </div>
            <div class="input-group">
                <label for="newPassword">Nova Senha:</label>
                <input type="password" id="newPassword" required>
            </div>
            <div class="input-group">
                <label for="confirmNewPassword">Confirmar Nova Senha:</label>
                <input type="password" id="confirmNewPassword" required>
            </div>
            <div class="modal-footer">
                <button id="changePasswordModalCancelBtn" class="btn-secondary">Cancelar</button>
                <button id="changePasswordModalSaveBtn" class="save">Guardar Nova Senha</button>
            </div>
        </div>
    </div>

    <div id="harvestReportModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Gerar Relatório de Colheita</h2>
                <button id="harvestReportModalCloseBtn" class="modal-close-btn">&times;</button>
            </div>
            <p>Selecione as informações que deseja incluir no relatório.</p>
            <div id="reportOptionsContainer" class="permission-grid" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">
                <label class="permission-item"><input type="checkbox" data-column="variedade" checked> <i class="fas fa-seedling"></i> Variedade</label>
                <label class="permission-item"><input type="checkbox" data-column="idade" checked> <i class="fas fa-hourglass-half"></i> Idade Média (meses)</label>
                <label class="permission-item"><input type="checkbox" data-column="atr" checked> <i class="fas fa-vial"></i> ATR</label>
                <label class="permission-item"><input type="checkbox" data-column="maturador" checked> <i class="fas fa-flask"></i> Maturador Aplicado</label>
                <label class="permission-item"><input type="checkbox" data-column="diasAplicacao" checked> <i class="fas fa-calendar-day"></i> Dias desde Aplicação</label>
            </div>
            <div class="modal-footer">
                <button id="harvestReportModalCancelBtn" class="btn-secondary">Cancelar</button>
                <button id="harvestReportModalExcelBtn" class="save" style="background: var(--color-primary-dark);"><i class="fas fa-file-excel"></i> Gerar Excel</button>
                <button id="harvestReportModalPdfBtn" class="save" style="background: var(--color-danger);"><i class="fas fa-file-pdf"></i> Gerar PDF</button>
            </div>
        </div>
    </div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
    
    const App = {
        config: {
            appName: "Inspeção e Planejamento de Cana com IA",
            sessionKey: 'canaAppUserSession',
            inactivityTimeout: 5 * 60 * 1000, // 5 minutes
            menuConfig: [
                { label: 'Dashboard', icon: 'fas fa-tachometer-alt', target: 'dashboard', permission: 'dashboard' },
                { label: 'Plan. Colheita', icon: 'fas fa-tractor', target: 'planejamentoColheita', permission: 'planejamentoColheita' },
                { label: 'Plan. Inspeção', icon: 'fas fa-calendar-alt', target: 'planejamento', permission: 'planejamento' },
                {
                    label: 'Lançamentos', icon: 'fas fa-pen-to-square',
                    submenu: [
                        { label: 'Lançamento Broca', icon: 'fas fa-bug', target: 'lancamentoBroca', permission: 'lancamentoBroca' },
                        { label: 'Lançamento Perda', icon: 'fas fa-dollar-sign', target: 'lancamentoPerda', permission: 'lancamentoPerda' },
                    ]
                },
                {
                    label: 'Relatórios', icon: 'fas fa-chart-line',
                    submenu: [
                        { label: 'Relatório Broca', icon: 'fas fa-chart-bar', target: 'relatorioBroca', permission: 'relatorioBroca' },
                        { label: 'Relatório Perda', icon: 'fas fa-chart-pie', target: 'relatorioPerda', permission: 'relatorioPerda' },
                    ]
                },
                {
                    label: 'Administrativo', icon: 'fas fa-cogs',
                    submenu: [
                        { label: 'Cadastros', icon: 'fas fa-book', target: 'cadastros', permission: 'configuracoes' },
                        { label: 'Cadastrar Pessoas', icon: 'fas fa-id-card', target: 'cadastrarPessoas', permission: 'cadastrarPessoas' },
                        { label: 'Gerir Utilizadores', icon: 'fas fa-users-cog', target: 'gerenciarUsuarios', permission: 'gerenciarUsuarios' },
                        { label: 'Configurações da Empresa', icon: 'fas fa-building', target: 'configuracoesEmpresa', permission: 'configuracoes' },
                        { label: 'Excluir Lançamentos', icon: 'fas fa-trash', target: 'excluirDados', permission: 'excluir' },
                    ]
                },
            ],
            roles: {
                admin: { dashboard: true, planejamentoColheita: true, planejamento: true, lancamentoBroca: true, lancamentoPerda: true, relatorioBroca: true, relatorioPerda: true, excluir: true, gerenciarUsuarios: true, configuracoes: true, cadastrarPessoas: true },
                supervisor: { dashboard: true, planejamentoColheita: true, planejamento: true, relatorioBroca: true, relatorioPerda: true, configuracoes: true, cadastrarPessoas: true, gerenciarUsuarios: true },
                tecnico: { dashboard: true, lancamentoBroca: true, lancamentoPerda: true, relatorioBroca: true, relatorioPerda: true },
                colaborador: { dashboard: true, lancamentoBroca: true, lancamentoPerda: true },
                user: { dashboard: true }
            }
        },

        state: {
            currentUser: null, users: [], registros: [], perdas: [], planos: [], 
            fazendas: [], personnel: [], companyLogo: null, activeSubmenu: null, charts: {},
            harvestPlans: [],
            activeHarvestPlan: null,
            inactivityTimer: null,
        },

        elements: {
            loadingOverlay: document.getElementById('loading-overlay'),
            loginScreen: document.getElementById('loginScreen'), appScreen: document.getElementById('appScreen'),
            loginUser: document.getElementById('loginUser'), loginPass: document.getElementById('loginPass'),
            btnLogin: document.getElementById('btnLogin'), loginMessage: document.getElementById('loginMessage'),
            headerTitle: document.querySelector('header h1'),
            userNameDisplay: document.getElementById('userNameDisplay'), currentDateTime: document.getElementById('currentDateTime'),
            logoutBtn: document.getElementById('logoutBtn'), btnToggleMenu: document.getElementById('btnToggleMenu'),
            menu: document.getElementById('menu'), content: document.getElementById('content'),
            alertContainer: document.getElementById('alertContainer'),
            userMenu: {
                container: document.getElementById('user-menu-container'),
                toggle: document.getElementById('user-menu-toggle'),
                dropdown: document.getElementById('user-menu-dropdown'),
                username: document.getElementById('userMenuUsername'),
                changePasswordBtn: document.getElementById('changePasswordBtn'),
            },
            confirmationModal: {
                overlay: document.getElementById('confirmationModal'),
                title: document.getElementById('confirmationModalTitle'),
                message: document.getElementById('confirmationModalMessage'),
                confirmBtn: document.getElementById('confirmationModalConfirmBtn'),
                cancelBtn: document.getElementById('confirmationModalCancelBtn'),
                closeBtn: document.getElementById('confirmationModalCloseBtn'),
            },
            changePasswordModal: {
                overlay: document.getElementById('changePasswordModal'),
                closeBtn: document.getElementById('changePasswordModalCloseBtn'),
                cancelBtn: document.getElementById('changePasswordModalCancelBtn'),
                saveBtn: document.getElementById('changePasswordModalSaveBtn'),
                currentPassword: document.getElementById('currentPassword'),
                newPassword: document.getElementById('newPassword'),
                confirmNewPassword: document.getElementById('confirmNewPassword'),
            },
            companyConfig: {
                logoUploadArea: document.getElementById('logoUploadArea'),
                logoInput: document.getElementById('logoInput'),
                logoPreview: document.getElementById('logoPreview'),
                removeLogoBtn: document.getElementById('removeLogoBtn'),
            },
            dashboard: {
                btnAnalisar: document.getElementById('btnAnalisarDashboard'),
                aiCard: document.getElementById('ai-analysis-card'),
                aiContent: document.getElementById('ai-analysis-content'),
            },
            users: {
                username: document.getElementById('newUserUsername'), password: document.getElementById('newUserPassword'),
                role: document.getElementById('newUserRole'), permissionsContainer: document.querySelector('.permission-grid'),
                permissionCheckboxes: document.querySelectorAll('#gerenciarUsuarios .permission-grid input[type="checkbox"]'),
                btnCreate: document.getElementById('btnCreateUser'), list: document.getElementById('usersList')
            },
            userEditModal: {
                overlay: document.getElementById('userEditModal'),
                title: document.getElementById('userEditModalTitle'),
                closeBtn: document.getElementById('userEditModalCloseBtn'),
                editingUserId: document.getElementById('editingUserId'),
                username: document.getElementById('editUserUsername'),
                role: document.getElementById('editUserRole'),
                permissionGrid: document.getElementById('editUserPermissionGrid'),
                btnSaveChanges: document.getElementById('btnSaveUserChanges'),
                btnResetPassword: document.getElementById('btnResetPassword'),
                btnDeleteUser: document.getElementById('btnDeleteUser'),
            },
            personnel: {
                id: document.getElementById('personnelId'),
                matricula: document.getElementById('personnelMatricula'),
                name: document.getElementById('personnelName'),
                btnSave: document.getElementById('btnSavePersonnel'),
                list: document.getElementById('personnelList'),
                csvUploadArea: document.getElementById('personnelCsvUploadArea'),
                csvFileInput: document.getElementById('personnelCsvInput'),
                btnDownloadCsvTemplate: document.getElementById('btnDownloadPersonnelCsvTemplate'),
            },
            cadastros: {
                farmCode: document.getElementById('farmCode'),
                farmName: document.getElementById('farmName'),
                btnSaveFarm: document.getElementById('btnSaveFarm'),
                farmSelect: document.getElementById('farmSelect'),
                talhaoManagementContainer: document.getElementById('talhaoManagementContainer'),
                selectedFarmName: document.getElementById('selectedFarmName'),
                talhaoList: document.getElementById('talhaoList'),
                talhaoId: document.getElementById('talhaoId'),
                talhaoName: document.getElementById('talhaoName'),
                talhaoArea: document.getElementById('talhaoArea'),
                talhaoProducao: document.getElementById('talhaoProducao'),
                talhaoCorte: document.getElementById('talhaoCorte'),
                talhaoVariedade: document.getElementById('talhaoVariedade'),
                talhaoDistancia: document.getElementById('talhaoDistancia'),
                talhaoUltimaColheita: document.getElementById('talhaoUltimaColheita'),
                btnSaveTalhao: document.getElementById('btnSaveTalhao'),
                csvUploadArea: document.getElementById('csvUploadArea'),
                csvFileInput: document.getElementById('csvFileInput'),
                btnDownloadCsvTemplate: document.getElementById('btnDownloadCsvTemplate'),
            },
            planejamento: {
                tipo: document.getElementById('planoTipo'), fazenda: document.getElementById('planoFazenda'),
                talhao: document.getElementById('planoTalhao'), data: document.getElementById('planoData'),
                responsavel: document.getElementById('planoResponsavel'), meta: document.getElementById('planoMeta'),
                obs: document.getElementById('planoObs'), btnAgendar: document.getElementById('btnAgendarInspecao'),
                btnSugerir: document.getElementById('btnSugerirPlano'),
                lista: document.getElementById('listaPlanejamento')
            },
            harvest: {
                plansListContainer: document.getElementById('harvest-plans-list-container'),
                plansList: document.getElementById('harvest-plans-list'),
                planEditor: document.getElementById('harvest-plan-editor'),
                btnAddNew: document.getElementById('btnAddNewHarvestPlan'),
                btnGeneralReportPDF: document.getElementById('btnGeneralHarvestReportPDF'),
                btnGeneralReportExcel: document.getElementById('btnGeneralHarvestReportExcel'),
                maturador: document.getElementById('harvestMaturador'),
                maturadorDate: document.getElementById('harvestMaturadorDate'),
                reportModal: {
                    overlay: document.getElementById('harvestReportModal'),
                    closeBtn: document.getElementById('harvestReportModalCloseBtn'),
                    cancelBtn: document.getElementById('harvestReportModalCancelBtn'),
                    pdfBtn: document.getElementById('harvestReportModalPdfBtn'),
                    excelBtn: document.getElementById('harvestReportModalExcelBtn'),
                    optionsContainer: document.getElementById('reportOptionsContainer')
                },
                btnSavePlan: document.getElementById('btnSaveHarvestPlan'),
                btnCancelPlan: document.getElementById('btnCancelHarvestPlan'),
                frontName: document.getElementById('harvestFrontName'),
                startDate: document.getElementById('harvestStartDate'),
                dailyRate: document.getElementById('harvestDailyRate'),
                fazenda: document.getElementById('harvestFazenda'),
                atr: document.getElementById('harvestAtr'),
                talhaoSelectionList: document.getElementById('harvestTalhaoSelectionList'),
                btnAddOrUpdate: document.getElementById('btnAddOrUpdateHarvestSequence'),
                btnCancelEdit: document.getElementById('btnCancelEditSequence'),
                addOrEditTitle: document.getElementById('addOrEditSequenceTitle'),
                editingGroupId: document.getElementById('editingGroupId'),
                btnOptimize: document.getElementById('btnOptimizeHarvest'),
                tableBody: document.querySelector('#harvestPlanTable tbody'),
                summary: document.getElementById('harvestSummary'),
            },
            broca: {
                form: document.getElementById('lancamentoBroca'),
                codigo: document.getElementById('codigo'), fazendaNome: document.getElementById('fazendaNome'),
                data: document.getElementById('data'), talhao: document.getElementById('talhao'),
                varietyDisplay: document.getElementById('varietyDisplay'),
                entrenos: document.getElementById('entrenos'), 
                base: document.getElementById('brocaBase'),
                meio: document.getElementById('brocaMeio'),
                topo: document.getElementById('brocaTopo'),
                brocado: document.getElementById('brocado'),
                resultado: document.getElementById('resultado'), btnSalvar: document.getElementById('btnSalvarBrocamento'),
                filtroFazenda: document.getElementById('fazendaFiltroBrocamento'), 
                tipoRelatorio: document.getElementById('tipoRelatorioBroca'),
                filtroInicio: document.getElementById('inicioBrocamento'),
                filtroFim: document.getElementById('fimBrocamento'), btnPDF: document.getElementById('btnPDFBrocamento'),
                btnExcel: document.getElementById('btnExcelBrocamento'),
            },
            perda: {
                form: document.getElementById('lancamentoPerda'),
                data: document.getElementById('dataPerda'), codigo: document.getElementById('codigoPerda'),
                fazendaNome: document.getElementById('fazendaNomePerda'), talhao: document.getElementById('talhaoPerda'),
                varietyDisplay: document.getElementById('varietyDisplayPerda'),
                frente: document.getElementById('frenteServico'), turno: document.getElementById('turno'),
                frota: document.getElementById('frotaEquipamento'),
                matricula: document.getElementById('matriculaOperador'),
                operadorNome: document.getElementById('operadorNome'),
                canaInteira: document.getElementById('canaInteira'), tolete: document.getElementById('tolete'),
                toco: document.getElementById('toco'), ponta: document.getElementById('ponta'),
                estilhaco: document.getElementById('estilhaco'), pedaco: document.getElementById('pedaco'),
                resultado: document.getElementById('resultadoPerda'), btnSalvar: document.getElementById('btnSalvarPerda'),
                filtroFazenda: document.getElementById('fazendaFiltroPerda'), filtroTalhao: document.getElementById('talhaoFiltroPerda'),
                filtroOperador: document.getElementById('operadorFiltroPerda'),
                filtroTurno: document.getElementById('turnoFiltroPerda'), filtroFrente: document.getElementById('frenteFiltroPerda'),
                filtroInicio: document.getElementById('inicioPerda'), filtroFim: document.getElementById('fimPerda'),
                tipoRelatorio: document.getElementById('tipoRelatorioPerda'), btnPDF: document.getElementById('btnPDFPerda'),
                btnExcel: document.getElementById('btnExcelPerda'),
            },
            exclusao: { lista: document.getElementById('listaExclusao') }
        },

        init() {
            this.data.loadAll();
            this.auth.initializeDefaultUsers();
            this.ui.setupEventListeners();
            this.auth.checkSession();
        },
        
        auth: {
            _hashPassword(password) { return CryptoJS.SHA256(password).toString(); },
            checkSession() {
                const sessionUser = App.data.load(App.config.sessionKey, null);
                if (sessionUser) {
                    const userInDb = App.state.users.find(u => u.id === sessionUser.id);
                    if (userInDb && userInDb.active) {
                        App.state.currentUser = userInDb;
                        App.ui.showAppScreen();
                    } else {
                        this.logout(); // User might have been deactivated
                    }
                } else {
                    App.ui.showLoginScreen();
                }
            },
            login() {
                const username = App.elements.loginUser.value.trim().toUpperCase();
                const password = App.elements.loginPass.value;
                if (!username || !password) { App.ui.showLoginMessage("Preencha utilizador e senha."); return; }
                const hashedPassword = this._hashPassword(password);
                const user = App.state.users.find(u => u.username.toUpperCase() === username && u.password === hashedPassword);
                if (user && user.active) { 
                    App.state.currentUser = user; 
                    App.data.save(App.config.sessionKey, user); // Save session
                    App.ui.showAppScreen(); 
                }
                else if (user && !user.active) { App.ui.showLoginMessage("Este utilizador está desativado."); }
                else { App.ui.showLoginMessage("Utilizador ou senha inválidos."); }
            },
            logout() { 
                App.state.currentUser = null; 
                localStorage.removeItem(App.config.sessionKey); // Clear session
                clearTimeout(App.state.inactivityTimer); // Stop inactivity timer
                App.ui.showLoginScreen(); 
            },
            createUser() {
                const els = App.elements.users;
                const username = els.username.value.trim();
                const password = els.password.value;
                if (!username || !password) { App.ui.showAlert("Preencha utilizador e senha.", "error"); return; }
                if (App.state.users.some(u => u.username.toUpperCase() === username.toUpperCase())) { App.ui.showAlert("Nome de utilizador já existe.", "error"); return; }
                const permissions = {};
                els.permissionCheckboxes.forEach(cb => { permissions[cb.id.replace('perm', '').toLowerCase()] = cb.checked; });
                const newUser = { id: Date.now(), username, password: this._hashPassword(password), role: els.role.value, active: true, permissions };
                App.state.users.push(newUser);
                App.data.saveUsers();
                App.ui.renderUsersList();
                App.ui.showAlert(`Utilizador ${username} criado com sucesso!`);
                els.username.value = ''; els.password.value = ''; els.role.value = 'user';
                App.ui.updatePermissionsForRole('user');
            },
            deleteUser(userId) {
                const userToDelete = App.state.users.find(u => u.id == userId);
                if (!userToDelete) return;
                
                if (confirm(`Tem a certeza que deseja EXCLUIR PERMANENTEMENTE o utilizador ${userToDelete.username}? Esta ação não pode ser desfeita.`)) {
                    App.state.users = App.state.users.filter(u => u.id != userId);
                    App.data.saveUsers(); 
                    App.ui.renderUsersList();
                    App.ui.closeUserEditModal();
                    App.ui.showAlert(`Utilizador ${userToDelete.username} excluído.`, 'success');
                }
            },
            toggleUserStatus(userId) {
                const user = App.state.users.find(u => u.id == userId); 
                if (!user) return;
                user.active = !user.active; 
                App.data.saveUsers(); 
                App.ui.renderUsersList();
                App.ui.showAlert(`Utilizador ${user.username} ${user.active ? 'ativado' : 'desativado'}.`, 'success');
            },
            resetUserPassword(userId) {
                const user = App.state.users.find(u => u.id == userId);
                if (!user) return;
                const newPassword = 'novaSenha123';
                if (confirm(`Deseja redefinir a senha de ${user.username} para "${newPassword}"?`)) {
                    user.password = this._hashPassword(newPassword); App.data.saveUsers();
                    App.ui.showAlert(`Senha de ${user.username} foi redefinida.`, 'warning');
                }
            },
            saveUserChanges(userId) {
                const user = App.state.users.find(u => u.id == userId);
                if (!user) return;

                const modalEls = App.elements.userEditModal;
                user.role = modalEls.role.value;

                const permissions = {};
                modalEls.permissionGrid.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    permissions[cb.dataset.permission] = cb.checked;
                });
                user.permissions = permissions;

                App.data.saveUsers();
                App.ui.renderUsersList();
                App.ui.showAlert(`Alterações para ${user.username} guardadas com sucesso!`);
                App.ui.closeUserEditModal();
            },
            initializeDefaultUsers() {
                const debugEl = document.getElementById('debugInfo');
                if (App.state.users.length === 0) {
                    if (debugEl) debugEl.textContent = 'Debug: Nenhum utilizador encontrado, a criar os padrões...';
                    App.state.users = [
                        { id: 1, username: 'admin', password: this._hashPassword('admin123'), role: 'admin', active: true, permissions: App.config.roles.admin },
                        { id: 2, username: 'supervisor', password: this._hashPassword('super123'), role: 'supervisor', active: true, permissions: App.config.roles.supervisor },
                        { id: 3, username: 'tecnico', password: this._hashPassword('tec123'), role: 'tecnico', active: true, permissions: App.config.roles.tecnico },
                        { id: 4, username: 'colaborador', password: this._hashPassword('colab123'), role: 'colaborador', active: true, permissions: App.config.roles.colaborador },
                    ];
                    App.data.saveUsers();
                    if (debugEl) debugEl.textContent += ` ${App.state.users.length} utilizadores criados.`;
                } else {
                        if (debugEl) debugEl.textContent = `Debug: ${App.state.users.length} utilizador(es) carregado(s).`;
                }
            }
        },

        data: {
            loadAll() { this.loadFazendas(); this.loadUsers(); this.loadPersonnel(); this.loadLogo(); this.loadPlanos(); this.loadHarvestPlans(); this.loadRegistros(); this.loadPerdas(); },
            load(key, defaultValue = []) { try { return JSON.parse(localStorage.getItem(key)) || defaultValue; } catch (e) { return defaultValue; } },
            save(key, data) { try { localStorage.setItem(key, JSON.stringify(data)); } catch (e) { console.error(`Erro ao guardar '${key}'`, e); } },
            loadFazendas() { App.state.fazendas = this.load('fazendas', [{code: '4012', name: "FAZ. LAGOA CERCADA", talhoes: [{id: 1, name: 'T-01', area: 50, producao: 4000, variedade: 'RB867515', corte: 2, distancia: 10, dataUltimaColheita: '2024-07-15'}, {id: 2, name: 'T-02', area: 35.5, producao: 3100, variedade: 'CTC4', corte: 3, distancia: 12, dataUltimaColheita: '2024-08-01'}, {id: 3, name: 'T-03A', area: 22, producao: 1950, variedade: 'RB966928', corte: 1, distancia: 11, dataUltimaColheita: '2024-06-20'}]}, {code: '4005', name: "FAZ. MAURO BORGES", talhoes: [{id: 34, name: 'T-MB-34', area: 2.84, producao: 227.2, variedade: 'RB988082', corte: 1, distancia: 25, dataUltimaColheita: '2024-05-10'}, {id: 35, name: 'T-MB-35', area: 3.1, producao: 250, variedade: 'RB988082', corte: 1, distancia: 26, dataUltimaColheita: '2024-05-15'}, {id: 36, name: 'T-MB-36', area: 5.2, producao: 450, variedade: 'RB988082', corte: 2, distancia: 27, dataUltimaColheita: '2024-05-20'}, {id: 4, name: 'T-MB-04', area: 10, producao: 900, variedade: 'CTC9001', corte: 4, distancia: 22, dataUltimaColheita: '2024-04-25'}, {id: 5, name: 'T-MB-05', area: 12, producao: 1100, variedade: 'CTC9001', corte: 4, distancia: 23, dataUltimaColheita: '2024-04-30'}, {id: 6, name: 'T-MB-06', area: 8, producao: 750, variedade: 'CTC9001', corte: 3, distancia: 24, dataUltimaColheita: '2024-06-05'}]}]); },
            saveFazendas() { this.save('fazendas', App.state.fazendas); },
            loadUsers() { App.state.users = this.load('users', []); },
            saveUsers() { this.save('users', App.state.users); },
            loadPersonnel() { App.state.personnel = this.load('personnel', []); },
            savePersonnel() { this.save('personnel', App.state.personnel); },
            loadLogo() { App.state.companyLogo = this.load('companyLogo', null); },
            saveLogo() { this.save('companyLogo', App.state.companyLogo); },
            loadPlanos() { App.state.planos = this.load('planos', []); },
            savePlanos() { this.save('planos', App.state.planos); },
            loadHarvestPlans() { App.state.harvestPlans = this.load('harvestPlans', []); },
            saveHarvestPlans() { this.save('harvestPlans', App.state.harvestPlans); },
            loadRegistros() { App.state.registros = this.load('registros', []); },
            saveRegistros() { this.save('registros', App.state.registros); },
            loadPerdas() { App.state.perdas = this.load('perdas', []); },
            savePerdas() { this.save('perdas', App.state.perdas); },
        },
        
        ui: {
            setLoading(isLoading) {
                App.elements.loadingOverlay.style.display = isLoading ? 'flex' : 'none';
            },
            showLoginScreen() {
                App.elements.loginScreen.style.display = 'flex'; 
                App.elements.appScreen.style.display = 'none';
                App.elements.userMenu.container.style.display = 'none';
                App.elements.loginUser.value = '';
                App.elements.loginPass.value = ''; 
                App.elements.loginUser.focus(); 
                this.closeAllMenus();
            },
            showAppScreen() {
                const { currentUser } = App.state;
                App.elements.loginScreen.style.display = 'none'; 
                App.elements.appScreen.style.display = 'flex';
                App.elements.userMenu.container.style.display = 'block';
                App.elements.userMenu.username.textContent = currentUser.username;
                this.updateDateTime(); 
                setInterval(() => this.updateDateTime(), 60000);
                this.renderMenu(); 
                this.renderAllDynamicContent();
                App.actions.resetInactivityTimer();
                if (currentUser.username === 'admin' && App.auth._hashPassword('admin123') === currentUser.password) {
                    this.showAlert("Por segurança, altere a sua senha padrão.", "warning");
                }
            },
            renderAllDynamicContent() {
                this.populateFazendaSelects(); 
                this.populateUserSelects();
                this.populateOperatorSelects();
                this.renderUsersList();
                this.renderPersonnelList();
                this.renderLogoPreview();
                this.renderPlanejamento();
                this.showHarvestPlanList();
                this.showTab('dashboard'); App.charts.renderAll();
            },
            showLoginMessage(message) { App.elements.loginMessage.textContent = message; },
            showAlert(message, type = 'success', duration = 3000) {
                const { alertContainer } = App.elements;
                const icons = { success: 'check-circle', error: 'exclamation-circle', warning: 'info-circle', info: 'info-circle' };
                alertContainer.innerHTML = `<i class="fas fa-${icons[type] || 'info-circle'}"></i> ${message}`;
                alertContainer.className = `show ${type}`;
                setTimeout(() => alertContainer.classList.remove('show'), duration);
            },
            updateDateTime() { App.elements.currentDateTime.innerHTML = `<i class="fas fa-clock"></i> ${new Date().toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}`; },
            renderMenu() {
                const { menu } = App.elements; const { menuConfig } = App.config; const { currentUser } = App.state;
                menu.innerHTML = ''; 
                const menuContent = document.createElement('div');
                menuContent.className = 'menu-content';
                menu.appendChild(menuContent);

                const createMenuItem = (item) => {
                    if (!item.submenu && !currentUser.permissions[item.permission]) return null;
                    if (item.submenu && !item.submenu.some(sub => currentUser.permissions[sub.permission])) return null;
                    
                    const btn = document.createElement('button');
                    btn.className = 'menu-btn';
                    btn.innerHTML = `<i class="${item.icon}"></i> <span>${item.label}</span>`;
                    
                    if (item.submenu) {
                        btn.innerHTML += '<span class="arrow">&rsaquo;</span>';
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            this.renderSubmenu(item);
                        });
                    } else {
                        btn.addEventListener('click', () => {
                            this.closeAllMenus();
                            this.showTab(item.target);
                        });
                    }
                    return btn;
                };
                menuConfig.forEach(item => { const menuItem = createMenuItem(item); if (menuItem) menuContent.appendChild(menuItem); });
            },
            renderSubmenu(parentItem) {
                const { menu } = App.elements;
                let submenuContent = menu.querySelector('.submenu-content');
                if (submenuContent) submenuContent.remove();

                submenuContent = document.createElement('div');
                submenuContent.className = 'submenu-content';

                const backBtn = document.createElement('button');
                backBtn.className = 'submenu-back-btn';
                backBtn.innerHTML = '<i class="fas fa-arrow-left"></i> <span>Voltar</span>';
                backBtn.onclick = () => {
                    submenuContent.classList.remove('active');
                    setTimeout(() => this.renderMenu(), 300);
                };
                submenuContent.appendChild(backBtn);
                
                parentItem.submenu.forEach(subItem => {
                    if (App.state.currentUser.permissions[subItem.permission]) {
                        const subBtn = document.createElement('button');
                        subBtn.className = 'submenu-btn';
                        subBtn.innerHTML = `<i class="${subItem.icon}"></i> ${subItem.label}`;
                        subBtn.addEventListener('click', () => {
                            this.closeAllMenus();
                            this.showTab(subItem.target);
                        });
                        submenuContent.appendChild(subBtn);
                    }
                });
                menu.appendChild(submenuContent);
                requestAnimationFrame(() => submenuContent.classList.add('active'));
            },
            closeAllMenus() {
                document.body.classList.remove('mobile-menu-open');
                App.elements.menu.classList.remove('open');
                App.elements.btnToggleMenu.classList.remove('open');
                const activeSubmenu = App.elements.menu.querySelector('.submenu-content.active');
                if(activeSubmenu) activeSubmenu.classList.remove('active');
            },
            showTab(id) {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                const tab = document.getElementById(id);
                if (tab) {
                    tab.classList.add('active');
                    if(id === 'dashboard') App.charts.renderAll();
                    if(id === 'excluirDados') this.renderExclusao();
                    if(id === 'gerenciarUsuarios') this.renderUsersList();
                    if(id === 'cadastros') this.renderFarmSelect();
                    if(id === 'cadastrarPessoas') this.renderPersonnelList();
                    if(id === 'planejamento') this.renderPlanejamento();
                    if(id === 'planejamentoColheita') this.showHarvestPlanList();
                    if(id === 'lancamentoBroca') this.clearForm(App.elements.broca.form);
                    if(id === 'lancamentoPerda') this.clearForm(App.elements.perda.form);
                }
                this.closeAllMenus();
            },
            clearForm(formElement) {
                if (!formElement) return;
                const inputs = formElement.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.type === 'checkbox' || input.type === 'radio') {
                        input.checked = false;
                    } else if (input.type === 'number' && (input.id === 'brocaBase' || input.id === 'brocaMeio' || input.id === 'brocaTopo')) {
                        input.value = '0';
                    } else {
                        input.value = '';
                    }
                });
                formElement.querySelectorAll('.info-display').forEach(el => el.textContent = '');
                formElement.querySelectorAll('.resultado').forEach(el => el.textContent = '');
            },
            populateFazendaSelects() {
                const selects = [App.elements.broca.filtroFazenda, App.elements.perda.filtroFazenda, App.elements.planejamento.fazenda, App.elements.harvest.fazenda, App.elements.cadastros.farmSelect];
                selects.forEach(select => {
                    if (!select) return;
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Selecione...</option>';
                    App.state.fazendas.sort((a, b) => parseInt(a.code) - parseInt(b.code)).forEach(farm => {
                        select.innerHTML += `<option value="${farm.code}">${farm.code} - ${farm.name}</option>`;
                    });
                    select.value = currentValue;
                });
            },
            populateUserSelects() {
                const select = App.elements.planejamento.responsavel;
                select.innerHTML = '<option value="">Selecione...</option>';
                App.state.users
                    .filter(u => u.role === 'tecnico' || u.role === 'colaborador' || u.role === 'supervisor')
                    .forEach(user => { select.innerHTML += `<option value="${user.username}">${user.username}</option>`; });
            },
            populateOperatorSelects() {
                const select = App.elements.perda.filtroOperador;
                select.innerHTML = '<option value="">Todos</option>';
                App.state.personnel
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .forEach(p => {
                        select.innerHTML += `<option value="${p.matricula}">${p.name}</option>`;
                    });
            },
            renderFarmSelect() {
                const { farmSelect } = App.elements.cadastros;
                farmSelect.innerHTML = '<option value="">Selecione uma fazenda...</option>';
                App.state.fazendas.sort((a,b) => parseInt(a.code) - parseInt(b.code)).forEach(farm => {
                    farmSelect.innerHTML += `<option value="${farm.code}">${farm.code} - ${farm.name}</option>`;
                });
            },
            renderTalhaoList(farmCode) {
                const { talhaoList, talhaoManagementContainer, selectedFarmName } = App.elements.cadastros;
                const farm = App.state.fazendas.find(f => f.code === farmCode);
                talhaoList.innerHTML = '';
                if (!farm) {
                    talhaoManagementContainer.style.display = 'none';
                    return;
                }
                talhaoManagementContainer.style.display = 'block';
                selectedFarmName.textContent = `${farm.code} - ${farm.name}`;

                if (!farm.talhoes || farm.talhoes.length === 0) {
                    talhaoList.innerHTML = '<p>Nenhum talhão cadastrado para esta fazenda.</p>';
                    return;
                }
                const table = document.createElement('table');
                table.id = 'harvestPlanTable'; 
                table.innerHTML = `<thead><tr><th>Nome</th><th>Área</th><th>Produção</th><th>Variedade</th><th>Corte</th><th>Distância</th><th>Última Colheita</th><th>Ações</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');
                farm.talhoes.sort((a,b) => a.name.localeCompare(b.name)).forEach(talhao => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${talhao.name}</td>
                        <td>${talhao.area || ''}</td>
                        <td>${talhao.producao || ''}</td>
                        <td>${talhao.variedade || ''}</td>
                        <td>${talhao.corte || ''}</td>
                        <td>${talhao.distancia || ''}</td>
                        <td>${talhao.dataUltimaColheita ? new Date(talhao.dataUltimaColheita + 'T03:00:00Z').toLocaleDateString('pt-BR') : ''}</td>
                        <td>
                            <button class="btn-excluir" style="background:var(--color-info)" data-action="edit-talhao" data-id="${talhao.id}"><i class="fas fa-edit"></i></button>
                            <button class="btn-excluir" data-action="delete-talhao" data-id="${talhao.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                });
                talhaoList.appendChild(table);
            },
            renderHarvestTalhaoSelection(farmCode, plotIdsToCheck = []) {
                const { talhaoSelectionList, editingGroupId } = App.elements.harvest;
                talhaoSelectionList.innerHTML = '';

                if (!App.state.activeHarvestPlan) return;

                const farm = App.state.fazendas.find(f => f.code === farmCode);
                if (!farm || !farm.talhoes || farm.talhoes.length === 0) {
                    talhaoSelectionList.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">Nenhum talhão cadastrado nesta fazenda.</p>';
                    return;
                }

                // Get all plot IDs that are already in a sequence, excluding the one we are currently editing
                const allAssignedTalhaoIds = App.actions.getAssignedTalhaoIds(editingGroupId.value);
                
                // Filter the farm's plots to get only the available ones
                const availableTalhoes = farm.talhoes.filter(t => !allAssignedTalhaoIds.includes(t.id));

                if (availableTalhoes.length === 0 && plotIdsToCheck.length === 0) {
                        talhaoSelectionList.innerHTML = '<p style="grid-column: 1 / -1; text-align: center;">Todos os talhões desta fazenda já foram alocados em um plano.</p>';
                        return;
                }
                
                const talhoesToShow = [...availableTalhoes];
                if (plotIdsToCheck.length > 0) {
                    const currentlyEditedTalhoes = farm.talhoes.filter(t => plotIdsToCheck.includes(t.id));
                    talhoesToShow.push(...currentlyEditedTalhoes);
                }

                const uniqueTalhoesToShow = [...new Map(talhoesToShow.map(item => [item['id'], item])).values()];


                uniqueTalhoesToShow.sort((a,b) => a.name.localeCompare(b.name)).forEach(talhao => {
                    const isChecked = plotIdsToCheck.includes(talhao.id);
                    
                    const label = document.createElement('label');
                    label.className = 'talhao-selection-item';
                    label.htmlFor = `talhao-select-${talhao.id}`;

                    label.innerHTML = `
                        <input type="checkbox" id="talhao-select-${talhao.id}" data-talhao-id="${talhao.id}" ${isChecked ? 'checked' : ''}>
                        <div class="talhao-name">${talhao.name}</div>
                        <div class="talhao-details">
                            <span><i class="fas fa-ruler-combined"></i>Área: ${talhao.area || 0} ha</span>
                            <span><i class="fas fa-weight-hanging"></i>Produção: ${talhao.producao || 0} ton</span>
                            <span><i class="fas fa-seedling"></i>Variedade: ${talhao.variedade || 'N/A'}</span>
                            <span><i class="fas fa-cut"></i>Corte: ${talhao.corte || 'N/A'}</span>
                        </div>
                    `;
                    talhaoSelectionList.appendChild(label);
                });
            },
            updatePermissionsForRole(role, containerSelector = '#gerenciarUsuarios .permission-grid') {
                const permissions = App.config.roles[role] || {};
                const container = document.querySelector(containerSelector);
                container.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    const key = cb.id.includes('edit') ? cb.dataset.permission : cb.id.replace('perm', '').toLowerCase();
                    cb.checked = !!permissions[key];
                });
            },
            _createUserCardHTML(user) {
                const getRoleInfo = (role) => {
                    const roles = { admin: ['Administrador', 'var(--color-primary)'], supervisor: ['Supervisor', 'var(--color-warning)'], tecnico: ['Técnico', 'var(--color-accent)'], colaborador: ['Colaborador', 'var(--color-purple)'], user: ['Utilizador', '#718096'] };
                    return roles[role] || ['Desconhecido', '#718096'];
                };
                const [roleName, roleColor] = getRoleInfo(user.role);
                const buttonsHTML = user.username === App.state.currentUser.username ? '' : `
                    <button class="btn-excluir" style="background: ${user.active ? '#718096' : 'var(--color-success)'};" data-action="toggle" data-id="${user.id}">${user.active ? '<i class="fas fa-ban"></i> Desativar' : '<i class="fas fa-check"></i> Ativar'}</button>
                    <button class="btn-excluir" style="background: var(--color-info);" data-action="edit" data-id="${user.id}"><i class="fas fa-edit"></i> Editar</button>
                `;
                return `<div class="user-card"><div class="user-header"><div class="user-title">${user.username}<span class="user-role-badge" style="background: ${roleColor}; margin-left:10px; padding: 2px 8px; font-size: 12px; color: white; border-radius: 10px;">${roleName}</span></div><div class="user-status ${user.active ? '' : 'inactive'}" style="color: ${user.active ? 'var(--color-success)' : 'var(--color-danger)'}"><i class="fas fa-circle"></i> ${user.active ? 'Ativo' : 'Inativo'}</div></div><div class="user-actions" style="margin-top: 10px; display: flex; gap: 10px; justify-content: flex-end;">${buttonsHTML}</div></div>`;
            },
            renderUsersList() { const { list } = App.elements.users; list.innerHTML = App.state.users.map((u) => this._createUserCardHTML(u)).join(''); },
            renderPersonnelList() {
                const { list } = App.elements.personnel;
                list.innerHTML = '';
                if (App.state.personnel.length === 0) {
                    list.innerHTML = '<p>Nenhuma pessoa cadastrada.</p>';
                    return;
                }
                const table = document.createElement('table');
                table.id = 'personnelTable';
                table.className = 'harvestPlanTable'; // Re-use style
                table.innerHTML = `<thead><tr><th>Matrícula</th><th>Nome</th><th>Ações</th></tr></thead><tbody></tbody>`;
                const tbody = table.querySelector('tbody');
                App.state.personnel.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${p.matricula}</td>
                        <td>${p.name}</td>
                        <td>
                            <button class="btn-excluir" style="background:var(--color-info)" data-action="edit-personnel" data-id="${p.id}"><i class="fas fa-edit"></i></button>
                            <button class="btn-excluir" data-action="delete-personnel" data-id="${p.id}"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                });
                list.appendChild(table);
            },
            renderLogoPreview() {
                const { logoPreview, removeLogoBtn } = App.elements.companyConfig;
                if (App.state.companyLogo) {
                    logoPreview.src = App.state.companyLogo;
                    logoPreview.style.display = 'block';
                    removeLogoBtn.style.display = 'inline-flex';
                } else {
                    logoPreview.style.display = 'none';
                    removeLogoBtn.style.display = 'none';
                }
            },
            renderExclusao() {
                const { lista } = App.elements.exclusao; lista.innerHTML = ''; let content = '';
                if (App.state.registros.length > 0) {
                    content += `<h3>Brocamento</h3>`;
                    content += App.state.registros.map((reg, i) => `<div class="user-card"><strong>${reg.fazenda}</strong> - ${reg.talhao} (${reg.data}) <button class="btn-excluir" data-type="brocamento" data-index="${i}"><i class="fas fa-trash"></i> Excluir</button></div>`).join('');
                }
                if (App.state.perdas.length > 0) {
                    content += `<h3 style="margin-top:20px;">Perda de Cana</h3>`;
                    content += App.state.perdas.map((p, i) => `<div class="user-card"><strong>${p.fazenda}</strong> - ${p.talhao} (${p.data}) <button class="btn-excluir" data-type="perda" data-index="${i}"><i class="fas fa-trash"></i> Excluir</button></div>`).join('');
                }
                lista.innerHTML = content || '<p>Nenhum lançamento encontrado.</p>';
            },
            renderPlanejamento() {
                const { lista } = App.elements.planejamento; lista.innerHTML = '';
                const hoje = new Date(); hoje.setHours(0,0,0,0);
                const planosOrdenados = [...App.state.planos].sort((a,b) => new Date(a.dataPrevista) - new Date(b.dataPrevista));
                if(planosOrdenados.length === 0) { lista.innerHTML = '<p style="text-align:center; padding: 20px; color: var(--color-text-light);">Nenhuma inspeção planeada.</p>'; return; }
                planosOrdenados.forEach(plano => {
                    let status = plano.status;
                    const dataPlano = new Date(plano.dataPrevista + 'T03:00:00Z');
                    if (plano.status === 'Pendente' && dataPlano < hoje) { status = 'Atrasado'; }
                    const fazenda = App.state.fazendas.find(f => f.code === plano.fazendaCodigo);
                    const fazendaNome = fazenda ? `${fazenda.code} - ${fazenda.name}` : 'Desconhecida';
                    const card = document.createElement('div'); card.className = 'plano-card';
                    card.innerHTML = `<div class="plano-header"><span class="plano-title"><i class="fas fa-${plano.tipo === 'broca' ? 'bug' : 'dollar-sign'}"></i> ${fazendaNome} - Talhão: ${plano.talhao}</span><span class="plano-status ${status.toLowerCase()}">${status}</span></div><div class="plano-details"><div><i class="fas fa-calendar-day"></i> Data Prevista: ${dataPlano.toLocaleDateString('pt-BR')}</div><div><i class="fas fa-user-check"></i> Responsável: ${plano.usuarioResponsavel}</div>${plano.meta ? `<div><i class="fas fa-bullseye"></i> Meta: ${plano.meta}</div>` : ''}</div>${plano.observacoes ? `<div style="margin-top:8px;font-size:14px;"><i class="fas fa-info-circle"></i> Obs: ${plano.observacoes}</div>` : ''}<div class="plano-actions">${status !== 'Concluído' ? `<button class="btn-excluir" style="background-color: var(--color-success)" data-action="concluir" data-id="${plano.id}"><i class="fas fa-check"></i> Marcar Concluído</button>` : ''}<button class="btn-excluir" data-action="excluir" data-id="${plano.id}"><i class="fas fa-trash"></i> Excluir</button></div>`;
                    lista.appendChild(card);
                });
            },
            showHarvestPlanList() {
                App.state.activeHarvestPlan = null;
                App.elements.harvest.plansListContainer.style.display = 'block';
                App.elements.harvest.planEditor.style.display = 'none';
                this.renderHarvestPlansList();
            },
            showHarvestPlanEditor() {
                App.elements.harvest.plansListContainer.style.display = 'none';
                App.elements.harvest.planEditor.style.display = 'block';
            },
            renderHarvestPlansList() {
                const { plansList } = App.elements.harvest;
                plansList.innerHTML = '';
                if(App.state.harvestPlans.length === 0) {
                    plansList.innerHTML = '<p style="text-align:center; padding: 20px; color: var(--color-text-light);">Nenhum plano de colheita criado. Clique em "Novo Plano" para começar.</p>';
                    return;
                }
                App.state.harvestPlans.forEach(plan => {
                    const totalProducao = plan.sequence.reduce((sum, group) => sum + group.totalProducao, 0);
                    const card = document.createElement('div');
                    card.className = 'plano-card';
                    card.innerHTML = `
                        <div class="plano-header">
                            <span class="plano-title"><i class="fas fa-tractor"></i> ${plan.frontName}</span>
                            <span class="plano-status pendente">${plan.sequence.length} fazenda(s)</span>
                        </div>
                        <div class="plano-details">
                            <div><i class="fas fa-calendar-day"></i> Início: ${new Date(plan.startDate + 'T03:00:00Z').toLocaleDateString('pt-BR')}</div>
                            <div><i class="fas fa-tasks"></i> ${plan.dailyRate} ton/dia</div>
                            <div><i class="fas fa-weight-hanging"></i> Total: ${totalProducao.toFixed(2)} ton</div>
                        </div>
                        <div class="plano-actions">
                            <button class="btn-excluir" style="background-color: var(--color-info); margin-left: 0;" data-action="edit" data-id="${plan.id}"><i class="fas fa-edit"></i> Editar</button>
                            <button class="btn-excluir" style="background-color: var(--color-purple);" data-action="report-custom" data-id="${plan.id}"><i class="fas fa-file-invoice"></i> Relatório</button>
                            <button class="btn-excluir" data-action="delete" data-id="${plan.id}"><i class="fas fa-trash"></i> Excluir</button>
                        </div>
                    `;
                    plansList.appendChild(card);
                });
            },
            renderHarvestSequence() {
                if (!App.state.activeHarvestPlan) return;
                const { tableBody, summary } = App.elements.harvest;
                const { startDate, dailyRate, sequence } = App.state.activeHarvestPlan;
                
                tableBody.innerHTML = '';
                let grandTotalProducao = 0;
                let grandTotalArea = 0;
                let currentDate = startDate ? new Date(startDate + 'T03:00:00Z') : new Date();
                const dailyTon = parseFloat(dailyRate) || 1;

                const tableHeaders = document.querySelector('#harvestPlanTable thead tr');
                if (tableHeaders) {
                    tableHeaders.innerHTML = `
                        <th>Seq.</th>
                        <th>Fazenda</th>
                        <th>Talhões</th>
                        <th>Área (ha)</th>
                        <th>Produção (ton)</th>
                        <th>ATR</th>
                        <th>Idade (m)</th>
                        <th>Maturador</th>
                        <th>Dias Aplic.</th>
                        <th>Entrada</th>
                        <th>Saída</th>
                        <th>Ação</th>
                    `;
                }

                sequence.forEach((group, index) => {
                    grandTotalProducao += group.totalProducao;
                    grandTotalArea += group.totalArea;

                    const diasNecessarios = dailyTon > 0 ? group.totalProducao / dailyTon : 0;
                    const dataEntrada = new Date(currentDate.getTime());
                    currentDate.setDate(currentDate.getDate() + diasNecessarios);
                    const dataSaida = new Date(currentDate.getTime());
                    
                    const idadeMediaMeses = App.actions.calculateAverageAge(group, startDate);
                    const diasAplicacao = App.actions.calculateMaturadorDays(group);

                    const row = tableBody.insertRow();
                    row.draggable = true;
                    row.dataset.id = group.id;
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${group.fazendaCodigo} - ${group.fazendaName}</td>
                        <td class="talhao-list-cell">${group.plots.map(p => p.talhaoName).join(', ')}</td>
                        <td>${group.totalArea.toFixed(2)}</td>
                        <td>${group.totalProducao.toFixed(2)}</td>
                        <td><span class="editable-atr" data-id="${group.id}">${group.atr || 'N/A'}</span></td>
                        <td>${idadeMediaMeses}</td>
                        <td>${group.maturador || 'N/A'}</td>
                        <td>${diasAplicacao}</td>
                        <td>${dataEntrada.toLocaleDateString('pt-BR')}</td>
                        <td>${dataSaida.toLocaleDateString('pt-BR')}</td>
                        <td>
                            <button class="btn-excluir" style="background-color: var(--color-info); margin-left: 0;" data-action="edit-harvest-group" data-id="${group.id}"><i class="fas fa-edit"></i></button>
                            <button class="btn-excluir" data-action="remove-harvest" data-id="${group.id}"><i class="fas fa-times"></i></button>
                        </td>
                    `;
                    currentDate.setDate(currentDate.getDate() + 1);
                });

                if (sequence.length > 0) {
                    const allVarieties = new Set();
                    sequence.forEach(group => {
                        const farm = App.state.fazendas.find(f => f.code === group.fazendaCodigo);
                        if(farm) {
                            group.plots.forEach(plot => {
                                const talhao = farm.talhoes.find(t => t.id === plot.talhaoId);
                                if(talhao && talhao.variedade) {
                                    allVarieties.add(talhao.variedade);
                                }
                            });
                        }
                    });
                    const varietiesString = allVarieties.size > 0 ? Array.from(allVarieties).join(', ') : 'N/A';

                    summary.innerHTML = `
                        <p>Produção Total Estimada: <span>${grandTotalProducao.toFixed(2)} ton</span></p>
                        <p>Área Total: <span>${grandTotalArea.toFixed(2)} ha</span></p>
                        <p>Data Final de Saída Prevista: <span>${currentDate.toLocaleDateString('pt-BR')}</span></p>
                        <p>Variedades na Sequência: <span>${varietiesString}</span></p>
                    `;
                } else {
                    summary.innerHTML = '<p>Adicione fazendas à sequência para ver o resumo da colheita.</p>';
                }
            },
            updateFazendaNome(inputEl, outputEl) { 
                const farm = App.state.fazendas.find(f => f.code === inputEl.value.trim());
                outputEl.textContent = farm ? `${farm.code} - ${farm.name}` : ''; 
            },
            validateFields(ids) { return ids.every(id => { const el = document.getElementById(id); const valid = el.value.trim() !== ''; el.style.borderColor = valid ? 'var(--color-border)' : 'var(--color-danger)'; if (!valid) el.focus(); return valid; }); },
            updateBrocadoTotal() {
                const { broca } = App.elements;
                const base = parseInt(broca.base.value) || 0;
                const meio = parseInt(broca.meio.value) || 0;
                const topo = parseInt(broca.topo.value) || 0;
                broca.brocado.value = base + meio + topo;
            },
            calculateBrocamento() {
                const entrenos = parseInt(App.elements.broca.entrenos.value) || 0; 
                const brocado = parseInt(App.elements.broca.brocado.value) || 0;
                const resultadoEl = App.elements.broca.resultado; 
                if (entrenos > 0) { 
                    const porcentagem = (brocado / entrenos) * 100; 
                    resultadoEl.textContent = `Brocamento: ${porcentagem.toFixed(2).replace('.', ',')}%`; 
                    resultadoEl.style.color = porcentagem > 20 ? 'var(--color-danger)' : 'var(--color-success)'; 
                } else { 
                    resultadoEl.textContent = ''; 
                }
            },
            calculatePerda() {
                const fields = ['canaInteira', 'tolete', 'toco', 'ponta', 'estilhaco', 'pedaco'];
                const total = fields.reduce((sum, id) => sum + (parseFloat(document.getElementById(id).value) || 0), 0);
                App.elements.perda.resultado.textContent = `Total Perda: ${total.toFixed(2).replace('.', ',')}`;
            },
            showConfirmationModal(message, onConfirm) {
                const { overlay, message: msgEl, confirmBtn, cancelBtn, closeBtn } = App.elements.confirmationModal;
                msgEl.textContent = message;

                const confirmHandler = () => {
                    onConfirm();
                    closeHandler();
                };
                const closeHandler = () => {
                    overlay.classList.remove('show');
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', closeHandler);
                    closeBtn.removeEventListener('click', closeHandler);
                };

                confirmBtn.addEventListener('click', confirmHandler);
                cancelBtn.addEventListener('click', closeHandler);
                closeBtn.addEventListener('click', closeHandler);
                overlay.classList.add('show');
            },
            openUserEditModal(userId) {
                const modalEls = App.elements.userEditModal;
                const user = App.state.users.find(u => u.id == userId);
                if (!user) return;

                modalEls.editingUserId.value = user.id;
                modalEls.title.textContent = `Editar Utilizador: ${user.username}`;
                modalEls.username.value = user.username;
                modalEls.role.value = user.role;

                // Populate permissions
                modalEls.permissionGrid.innerHTML = ''; // Clear previous
                const permissionItems = App.config.menuConfig.flatMap(item => item.submenu ? item.submenu : item);
                permissionItems.forEach(perm => {
                    if (!perm.permission) return;
                    const isChecked = user.permissions[perm.permission];
                    const label = document.createElement('label');
                    label.className = 'permission-item';
                    label.innerHTML = `<input type="checkbox" data-permission="${perm.permission}" ${isChecked ? 'checked' : ''}> <i class="${perm.icon}"></i> ${perm.label}`;
                    modalEls.permissionGrid.appendChild(label);
                });

                modalEls.overlay.classList.add('show');
            },
            closeUserEditModal() {
                App.elements.userEditModal.overlay.classList.remove('show');
            },
            setupEventListeners() {
                App.elements.loginUser.addEventListener('input', e => {
                    e.target.value = e.target.value.toUpperCase();
                });
                App.elements.btnLogin.addEventListener('click', () => App.auth.login());
                App.elements.loginPass.addEventListener('keypress', e => e.key === 'Enter' && App.auth.login());
                App.elements.logoutBtn.addEventListener('click', () => App.auth.logout());
                App.elements.btnToggleMenu.addEventListener('click', () => { 
                    document.body.classList.toggle('mobile-menu-open');
                    App.elements.menu.classList.toggle('open');
                    App.elements.btnToggleMenu.classList.toggle('open');
                });
                
                // Combined click listener for closing menus
                document.addEventListener('click', (e) => { 
                    // Close side menu
                    if (!App.elements.menu.contains(e.target) && !App.elements.btnToggleMenu.contains(e.target)) {
                        this.closeAllMenus();
                    }
                    // Close user menu
                    if (!App.elements.userMenu.container.contains(e.target)) {
                        App.elements.userMenu.dropdown.classList.remove('show');
                        App.elements.userMenu.toggle.classList.remove('open');
                        App.elements.userMenu.toggle.setAttribute('aria-expanded', 'false');
                    }
                });

                // User menu toggle
                App.elements.userMenu.toggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const dropdown = App.elements.userMenu.dropdown;
                    const toggle = App.elements.userMenu.toggle;
                    const isShown = dropdown.classList.toggle('show');
                    toggle.classList.toggle('open', isShown);
                    toggle.setAttribute('aria-expanded', isShown);
                });

                App.elements.dashboard.btnAnalisar.addEventListener('click', () => App.gemini.getDashboardAnalysis());
                App.elements.users.role.addEventListener('change', (e) => this.updatePermissionsForRole(e.target.value));
                App.elements.users.btnCreate.addEventListener('click', () => App.auth.createUser());
                App.elements.users.list.addEventListener('click', e => { 
                    const button = e.target.closest('button[data-action]'); 
                    if (!button) return; 
                    const { action, id } = button.dataset; 
                    if (action === 'edit') this.openUserEditModal(id);
                    if (action === 'toggle') App.auth.toggleUserStatus(id); 
                });
                // Modal listeners
                const modalEls = App.elements.userEditModal;
                modalEls.closeBtn.addEventListener('click', () => this.closeUserEditModal());
                modalEls.overlay.addEventListener('click', e => { if(e.target === modalEls.overlay) this.closeUserEditModal(); });
                modalEls.btnSaveChanges.addEventListener('click', () => App.auth.saveUserChanges(modalEls.editingUserId.value));
                modalEls.btnResetPassword.addEventListener('click', () => App.auth.resetUserPassword(modalEls.editingUserId.value));
                modalEls.btnDeleteUser.addEventListener('click', () => App.auth.deleteUser(modalEls.editingUserId.value));
                modalEls.role.addEventListener('change', (e) => this.updatePermissionsForRole(e.target.value, '#editUserPermissionGrid'));
                
                // Change Password Modal Listeners
                const cpModal = App.elements.changePasswordModal;
                App.elements.userMenu.changePasswordBtn.addEventListener('click', () => cpModal.overlay.classList.add('show'));
                cpModal.closeBtn.addEventListener('click', () => cpModal.overlay.classList.remove('show'));
                cpModal.cancelBtn.addEventListener('click', () => cpModal.overlay.classList.remove('show'));
                cpModal.saveBtn.addEventListener('click', () => App.actions.changePassword());


                // Personnel Listeners
                App.elements.personnel.btnSave.addEventListener('click', () => App.actions.savePersonnel());
                App.elements.personnel.list.addEventListener('click', e => {
                    const btn = e.target.closest('button');
                    if (!btn) return;
                    const { action, id } = btn.dataset;
                    if (action === 'edit-personnel') App.actions.editPersonnel(id);
                    if (action === 'delete-personnel') App.actions.deletePersonnel(id);
                });
                App.elements.personnel.csvUploadArea.addEventListener('click', () => App.elements.personnel.csvFileInput.click());
                App.elements.personnel.csvFileInput.addEventListener('change', (e) => App.actions.importPersonnelFromCSV(e.target.files[0]));
                App.elements.personnel.btnDownloadCsvTemplate.addEventListener('click', () => App.actions.downloadPersonnelCsvTemplate());
                
                // Company Config Listeners
                App.elements.companyConfig.logoUploadArea.addEventListener('click', () => App.elements.companyConfig.logoInput.click());
                App.elements.companyConfig.logoInput.addEventListener('change', (e) => App.actions.handleLogoUpload(e));
                App.elements.companyConfig.removeLogoBtn.addEventListener('click', () => App.actions.removeLogo());


                App.elements.cadastros.btnSaveFarm.addEventListener('click', () => App.actions.saveFarm());
                App.elements.cadastros.farmSelect.addEventListener('change', (e) => this.renderTalhaoList(e.target.value));
                App.elements.cadastros.talhaoList.addEventListener('click', e => { const btn = e.target.closest('button'); if(!btn) return; const { action, id } = btn.dataset; if(action === 'edit-talhao') App.actions.editTalhao(id); if(action === 'delete-talhao') App.actions.deleteTalhao(id); });
                App.elements.cadastros.btnSaveTalhao.addEventListener('click', () => App.actions.saveTalhao());
                App.elements.cadastros.csvUploadArea.addEventListener('click', () => App.elements.cadastros.csvFileInput.click());
                App.elements.cadastros.csvFileInput.addEventListener('change', (e) => App.actions.importFarmsFromCSV(e.target.files[0]));
                App.elements.cadastros.btnDownloadCsvTemplate.addEventListener('click', () => App.actions.downloadCsvTemplate());
                App.elements.planejamento.btnAgendar.addEventListener('click', () => App.actions.agendarInspecao());
                App.elements.planejamento.btnSugerir.addEventListener('click', () => App.gemini.getPlanningSuggestions());
                App.elements.planejamento.lista.addEventListener('click', (e) => { const button = e.target.closest('button[data-action]'); if(!button) return; const { action, id } = button.dataset; if (action === 'concluir') App.actions.marcarPlanoComoConcluido(id); if (action === 'excluir') App.actions.excluirPlano(id); });
                
                // --- Harvest Planning Listeners ---
                App.elements.harvest.btnAddNew.addEventListener('click', () => App.actions.editHarvestPlan());
                App.elements.harvest.btnGeneralReportPDF.addEventListener('click', () => App.reports.generateHarvestPlanPDF());
                App.elements.harvest.btnGeneralReportExcel.addEventListener('click', () => App.reports.generateHarvestPlanCSV());
                App.elements.harvest.btnCancelPlan.addEventListener('click', () => this.showHarvestPlanList());
                App.elements.harvest.btnSavePlan.addEventListener('click', () => App.actions.saveHarvestPlan());
                App.elements.harvest.plansList.addEventListener('click', (e) => {
                    const button = e.target.closest('button[data-action]');
                    if (!button) return;
                    const { action, id } = button.dataset;
                    if (action === 'edit') App.actions.editHarvestPlan(id);
                    if (action === 'delete') App.actions.deleteHarvestPlan(id);
                    if (action === 'report-custom') App.reports.openHarvestReportModal(id);
                });
                App.elements.harvest.fazenda.addEventListener('change', e => this.renderHarvestTalhaoSelection(e.target.value));
                App.elements.harvest.btnAddOrUpdate.addEventListener('click', () => App.actions.addOrUpdateHarvestSequence());
                App.elements.harvest.btnCancelEdit.addEventListener('click', () => App.actions.cancelEditSequence());
                App.elements.harvest.btnOptimize.addEventListener('click', () => App.gemini.getOptimizedHarvestSequence()); 
                App.elements.harvest.tableBody.addEventListener('click', e => { 
                    const removeBtn = e.target.closest('button[data-action="remove-harvest"]'); 
                    if (removeBtn) App.actions.removeHarvestSequence(removeBtn.dataset.id);
                    const editBtn = e.target.closest('button[data-action="edit-harvest-group"]');
                    if(editBtn) App.actions.editHarvestSequenceGroup(editBtn.dataset.id);
                    const atrSpan = e.target.closest('.editable-atr');
                    if (atrSpan) App.actions.editHarvestSequenceATR(atrSpan.dataset.id);
                });
                [App.elements.harvest.frontName, App.elements.harvest.startDate, App.elements.harvest.dailyRate].forEach(el => el.addEventListener('input', () => App.actions.updateActiveHarvestPlanDetails()));
                
                let dragSrcEl = null;
                App.elements.harvest.tableBody.addEventListener('dragstart', e => { dragSrcEl = e.target; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/html', e.target.innerHTML); });
                App.elements.harvest.tableBody.addEventListener('dragover', e => { e.preventDefault(); return false; });
                App.elements.harvest.tableBody.addEventListener('drop', e => { e.stopPropagation(); if (dragSrcEl !== e.target) { const targetRow = e.target.closest('tr'); if(targetRow) App.actions.reorderHarvestSequence(dragSrcEl.dataset.id, targetRow.dataset.id); } return false; });
                
                // --- Broca Listeners ---
                App.elements.broca.codigo.addEventListener('input', () => this.updateFazendaNome(App.elements.broca.codigo, App.elements.broca.fazendaNome));
                App.elements.broca.talhao.addEventListener('input', () => App.actions.findVarietyForTalhao('broca'));
                App.elements.broca.codigo.addEventListener('change', () => App.actions.findVarietyForTalhao('broca'));
                ['entrenos', 'brocaBase', 'brocaMeio', 'brocaTopo'].forEach(id => document.getElementById(id).addEventListener('input', () => {
                    this.updateBrocadoTotal();
                    this.calculateBrocamento();
                }));
                App.elements.broca.btnSalvar.addEventListener('click', () => App.actions.saveBrocamento());
                
                // --- Perda Listeners ---
                App.elements.perda.codigo.addEventListener('input', () => this.updateFazendaNome(App.elements.perda.codigo, App.elements.perda.fazendaNome));
                App.elements.perda.talhao.addEventListener('input', () => App.actions.findVarietyForTalhao('perda'));
                App.elements.perda.codigo.addEventListener('change', () => App.actions.findVarietyForTalhao('perda'));
                App.elements.perda.matricula.addEventListener('blur', () => App.actions.findOperatorName());
                ['canaInteira', 'tolete', 'toco', 'ponta', 'estilhaco', 'pedaco'].forEach(id => document.getElementById(id).addEventListener('input', () => this.calculatePerda()));
                App.elements.perda.btnSalvar.addEventListener('click', () => App.actions.savePerda());
                
                // --- Report Listeners ---
                App.elements.broca.btnPDF.addEventListener('click', () => App.reports.generateBrocamentoPDF());
                App.elements.broca.btnExcel.addEventListener('click', () => App.reports.generateBrocamentoCSV());
                App.elements.perda.btnPDF.addEventListener('click', () => App.reports.generatePerdaPDF());
                App.elements.perda.btnExcel.addEventListener('click', () => App.reports.generatePerdaCSV());
                App.elements.exclusao.lista.addEventListener('click', e => { const button = e.target.closest('button.btn-excluir'); if (button) App.actions.deleteEntry(button.dataset.type, button.dataset.index); });
                
                 // --- Report Modal Listeners ---
                const reportModal = App.elements.harvest.reportModal;
                reportModal.closeBtn.addEventListener('click', () => reportModal.overlay.classList.remove('show'));
                reportModal.cancelBtn.addEventListener('click', () => reportModal.overlay.classList.remove('show'));
                reportModal.overlay.addEventListener('click', e => { if (e.target === reportModal.overlay) reportModal.overlay.classList.remove('show'); });
                reportModal.pdfBtn.addEventListener('click', () => App.reports.generateCustomHarvestReport('pdf'));
                reportModal.excelBtn.addEventListener('click', () => App.reports.generateCustomHarvestReport('csv'));

                // --- Enter Key Navigation ---
                const formsToNavigate = ['#lancamentoBroca', '#lancamentoPerda'];
                formsToNavigate.forEach(formSelector => {
                    const form = document.querySelector(formSelector);
                    if (form) {
                        form.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA' && e.target.tagName !== 'BUTTON') {
                                e.preventDefault();
                                const fields = Array.from(form.querySelectorAll('input:not([readonly]):not([disabled]), select:not([disabled]), textarea:not([disabled])'));
                                const currentIndex = fields.indexOf(e.target);
                                const nextField = fields[currentIndex + 1];
                                if (nextField) {
                                    nextField.focus();
                                } else {
                                    form.querySelector('.save')?.focus();
                                }
                            }
                        });
                    }
                });

                // --- Inactivity Timer Events ---
                ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'].forEach(event => {
                    document.addEventListener(event, () => App.actions.resetInactivityTimer());
                });
            }
        },
actions: {
            resetInactivityTimer() {
                clearTimeout(App.state.inactivityTimer);
                if (App.state.currentUser) { // Only set timer if logged in
                    App.state.inactivityTimer = setTimeout(() => {
                        App.ui.showAlert('Sessão expirada por inatividade.', 'warning');
                        App.auth.logout();
                    }, App.config.inactivityTimeout);
                }
            },
            changePassword() {
                const els = App.elements.changePasswordModal;
                const currentPassword = els.currentPassword.value;
                const newPassword = els.newPassword.value;
                const confirmNewPassword = els.confirmNewPassword.value;

                if (!currentPassword || !newPassword || !confirmNewPassword) {
                    App.ui.showAlert("Preencha todos os campos.", "error");
                    return;
                }
                if (newPassword !== confirmNewPassword) {
                    App.ui.showAlert("As novas senhas não coincidem.", "error");
                    return;
                }
                const user = App.state.currentUser;
                if (App.auth._hashPassword(currentPassword) !== user.password) {
                    App.ui.showAlert("A senha atual está incorreta.", "error");
                    return;
                }

                user.password = App.auth._hashPassword(newPassword);
                App.data.saveUsers();
                App.ui.showAlert("Senha alterada com sucesso!", "success");
                els.overlay.classList.remove('show');
                els.currentPassword.value = '';
                els.newPassword.value = '';
                els.confirmNewPassword.value = '';
            },
            getAssignedTalhaoIds(editingGroupId = null) {
                const assignedIds = new Set();
                const currentPlanId = App.state.activeHarvestPlan ? App.state.activeHarvestPlan.id : null;

                App.state.harvestPlans.forEach(plan => {
                    // Only check other plans if we are editing an existing plan
                    if (currentPlanId && plan.id === currentPlanId) {
                        // This is the current plan, only add plots from groups NOT being edited
                            plan.sequence.forEach(group => {
                                if (editingGroupId && group.id == editingGroupId) {
                                    return;
                                }
                                group.plots.forEach(plot => assignedIds.add(plot.talhaoId));
                            });
                    } else {
                        // This is a different plan, add all its plots
                        plan.sequence.forEach(group => {
                            group.plots.forEach(plot => assignedIds.add(plot.talhaoId));
                        });
                    }
                });
                    // Also check the current unsaved plan's sequence
                if (App.state.activeHarvestPlan) {
                    App.state.activeHarvestPlan.sequence.forEach(group => {
                        if (editingGroupId && group.id == editingGroupId) {
                            return;
                        }
                        group.plots.forEach(plot => assignedIds.add(plot.talhaoId));
                    });
                }
                return Array.from(assignedIds);
            },
            saveFarm() {
                const { farmCode, farmName } = App.elements.cadastros;
                const code = farmCode.value.trim();
                const name = farmName.value.trim().toUpperCase();
                if (!code || !name) { App.ui.showAlert("Código e Nome da fazenda são obrigatórios.", "error"); return; }
                const existingFarm = App.state.fazendas.find(f => f.code === code);
                if (existingFarm) {
                    existingFarm.name = name;
                    App.ui.showAlert("Fazenda atualizada com sucesso!", "success");
                } else {
                    App.state.fazendas.push({ code, name, talhoes: [] });
                    App.ui.showAlert("Fazenda adicionada com sucesso!", "success");
                }
                App.data.saveFazendas();
                App.ui.populateFazendaSelects();
                App.ui.renderFarmSelect();
                farmCode.value = ''; farmName.value = '';
            },
            saveTalhao() {
                const { farmSelect, talhaoId, talhaoName, talhaoArea, talhaoProducao, talhaoCorte, talhaoVariedade, talhaoDistancia, talhaoUltimaColheita } = App.elements.cadastros;
                const farmCode = farmSelect.value;
                const farm = App.state.fazendas.find(f => f.code === farmCode);
                if (!farm) { App.ui.showAlert("Selecione uma fazenda.", "error"); return; }
                const talhaoData = {
                    id: talhaoId.value ? parseInt(talhaoId.value) : Date.now(),
                    name: talhaoName.value.trim().toUpperCase(),
                    area: parseFloat(talhaoArea.value),
                    producao: parseFloat(talhaoProducao.value),
                    corte: parseInt(talhaoCorte.value) || 1,
                    variedade: talhaoVariedade.value.trim(),
                    distancia: parseFloat(talhaoDistancia.value) || 0,
                    dataUltimaColheita: talhaoUltimaColheita.value
                };
                if (!talhaoData.name || !talhaoData.area || !talhaoData.producao) { App.ui.showAlert("Nome, Área e Produção do talhão são obrigatórios.", "error"); return; }
                
                if (!farm.talhoes) farm.talhoes = [];
                const existingIndex = farm.talhoes.findIndex(t => t.id === talhaoData.id);
                if (existingIndex > -1) {
                    farm.talhoes[existingIndex] = talhaoData;
                } else {
                    farm.talhoes.push(talhaoData);
                }
                App.data.saveFazendas();
                App.ui.renderTalhaoList(farmCode);
                [talhaoId, talhaoName, talhaoArea, talhaoProducao, talhaoCorte, talhaoVariedade, talhaoDistancia, talhaoUltimaColheita].forEach(el => el.value = '');
            },
            editTalhao(talhaoId) {
                const { farmSelect, ...talhaoEls } = App.elements.cadastros;
                const farm = App.state.fazendas.find(f => f.code === farmSelect.value);
                const talhao = farm?.talhoes.find(t => t.id == talhaoId);
                if (talhao) {
                    talhaoEls.talhaoId.value = talhao.id;
                    talhaoEls.talhaoName.value = talhao.name;
                    talhaoEls.talhaoArea.value = talhao.area;
                    talhaoEls.talhaoProducao.value = talhao.producao;
                    talhaoEls.talhaoCorte.value = talhao.corte;
                    talhaoEls.talhaoVariedade.value = talhao.variedade;
                    talhaoEls.talhaoDistancia.value = talhao.distancia;
                    talhaoEls.talhaoUltimaColheita.value = talhao.dataUltimaColheita;
                    talhaoEls.talhaoName.focus();
                }
            },
            deleteTalhao(talhaoId) {
                const farm = App.state.fazendas.find(f => f.code === App.elements.cadastros.farmSelect.value);
                if (farm && confirm("Tem a certeza que deseja excluir este talhão?")) {
                    farm.talhoes = farm.talhoes.filter(t => t.id != talhaoId);
                    App.data.saveFazendas();
                    App.ui.renderTalhaoList(farm.code);
                }
            },
            savePersonnel() {
                const { id, matricula, name } = App.elements.personnel;
                const matriculaValue = matricula.value.trim();
                const nameValue = name.value.trim();
                if (!matriculaValue || !nameValue) {
                    App.ui.showAlert("Matrícula e Nome são obrigatórios.", "error");
                    return;
                }
                const existingId = id.value;
                if (existingId) {
                    const person = App.state.personnel.find(p => p.id == existingId);
                    if (person) {
                        person.matricula = matriculaValue;
                        person.name = nameValue;
                    }
                } else {
                    if (App.state.personnel.some(p => p.matricula === matriculaValue)) {
                        App.ui.showAlert("Esta matrícula já está cadastrada.", "error");
                        return;
                    }
                    App.state.personnel.push({ id: Date.now(), matricula: matriculaValue, name: nameValue });
                }
                App.data.savePersonnel();
                App.ui.renderPersonnelList();
                App.ui.populateOperatorSelects();
                id.value = ''; matricula.value = ''; name.value = '';
            },
            editPersonnel(personnelId) {
                const { id, matricula, name } = App.elements.personnel;
                const person = App.state.personnel.find(p => p.id == personnelId);
                if (person) {
                    id.value = person.id;
                    matricula.value = person.matricula;
                    name.value = person.name;
                    matricula.focus();
                }
            },
            deletePersonnel(personnelId) {
                if (confirm("Tem certeza que deseja excluir esta pessoa?")) {
                    App.state.personnel = App.state.personnel.filter(p => p.id != personnelId);
                    App.data.savePersonnel();
                    App.ui.renderPersonnelList();
                    App.ui.populateOperatorSelects();
                }
            },
            handleLogoUpload(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    App.state.companyLogo = event.target.result;
                    App.data.saveLogo();
                    App.ui.renderLogoPreview();
                    App.ui.showAlert('Logo carregado com sucesso!');
                };
                reader.readAsDataURL(file);
            },
            removeLogo() {
                if (confirm("Tem certeza que deseja remover o logotipo?")) {
                    App.state.companyLogo = null;
                    App.data.saveLogo();
                    App.ui.renderLogoPreview();
                    App.elements.companyConfig.logoInput.value = ''; // Reset file input
                }
            },
            agendarInspecao() {
                const els = App.elements.planejamento;
                const campos = { tipo: els.tipo.value, fazendaCodigo: els.fazenda.value, talhao: els.talhao.value.trim(), dataPrevista: els.data.value, usuarioResponsavel: els.responsavel.value };
                if (Object.values(campos).some(v => !v)) { App.ui.showAlert("Todos os campos obrigatórios devem ser preenchidos.", "error"); return; }
                const novoPlano = { ...campos, id: Date.now(), meta: els.meta.value || null, observacoes: els.obs.value.trim() || null, status: 'Pendente' };
                App.state.planos.push(novoPlano); App.data.savePlanos(); App.ui.showAlert("Inspeção agendada com sucesso!", "success"); App.ui.renderPlanejamento();
                els.talhao.value = ''; els.data.value = ''; els.meta.value = ''; els.obs.value = '';
            },
            marcarPlanoComoConcluido(id) {
                const plano = App.state.planos.find(p => p.id == id);
                if (plano) { plano.status = 'Concluído'; App.data.savePlanos(); App.ui.renderPlanejamento(); App.ui.showAlert("Inspeção marcada como concluída!", "success"); }
            },
            excluirPlano(id) {
                if(confirm("Tem a certeza que deseja excluir este planeamento?")) {
                    App.state.planos = App.state.planos.filter(p => p.id != id); App.data.savePlanos(); App.ui.renderPlanejamento(); App.ui.showAlert("Planeamento excluído.", "info");
                }
            },
            verificarEAtualizarPlano(tipo, fazendaCodigo, talhao) {
                const planoPendente = App.state.planos.find(p => p.status === 'Pendente' && p.tipo === tipo && p.fazendaCodigo === fazendaCodigo && p.talhao.toLowerCase() === talhao.toLowerCase());
                if (planoPendente) { this.marcarPlanoComoConcluido(planoPendente.id); App.ui.showAlert(`Planeamento correspondente para ${talhao} foi concluído automaticamente.`, 'info'); }
            },
            findVarietyForTalhao(section) {
                const formElements = App.elements[section];
                const farmCode = formElements.codigo.value;
                const talhaoName = formElements.talhao.value.trim().toUpperCase();
                const display = formElements.varietyDisplay;
                
                display.textContent = '';
                if (!farmCode || !talhaoName) return;

                const farm = App.state.fazendas.find(f => f.code === farmCode);
                const talhao = farm?.talhoes.find(t => t.name.toUpperCase() === talhaoName);

                if (talhao && talhao.variedade) {
                    display.textContent = `Variedade: ${talhao.variedade}`;
                }
            },
            findOperatorName() {
                const { matricula, operadorNome } = App.elements.perda;
                const matriculaValue = matricula.value.trim();
                operadorNome.textContent = '';
                if (!matriculaValue) return;

                const operator = App.state.personnel.find(p => p.matricula === matriculaValue);
                if (operator) {
                    operadorNome.textContent = operator.name;
                    operadorNome.style.color = 'var(--color-primary)';
                } else {
                    operadorNome.textContent = 'Operador não encontrado';
                    operadorNome.style.color = 'var(--color-danger)';
                }
            },
            editHarvestPlan(planId = null) {
                App.ui.showHarvestPlanEditor();
                const { frontName, startDate, dailyRate } = App.elements.harvest;
                
                if (planId) {
                    const planToEdit = App.state.harvestPlans.find(p => p.id == planId);
                    App.state.activeHarvestPlan = JSON.parse(JSON.stringify(planToEdit)); 
                } else {
                    App.state.activeHarvestPlan = {
                        id: null,
                        frontName: '',
                        startDate: new Date().toISOString().split('T')[0],
                        dailyRate: 750,
                        sequence: []
                    };
                }
                
                frontName.value = App.state.activeHarvestPlan.frontName;
                startDate.value = App.state.activeHarvestPlan.startDate;
                dailyRate.value = App.state.activeHarvestPlan.dailyRate;

                App.ui.renderHarvestSequence();
                App.actions.cancelEditSequence();
            },
            updateActiveHarvestPlanDetails() {
                if (!App.state.activeHarvestPlan) return;
                const { frontName, startDate, dailyRate } = App.elements.harvest;
                App.state.activeHarvestPlan.frontName = frontName.value;
                App.state.activeHarvestPlan.startDate = startDate.value;
                App.state.activeHarvestPlan.dailyRate = parseFloat(dailyRate.value);
                App.ui.renderHarvestSequence();
            },
            saveHarvestPlan() {
                if (!App.state.activeHarvestPlan) return;

                const planToSave = App.state.activeHarvestPlan;
                
                planToSave.frontName = planToSave.frontName.trim();
                
                if (!planToSave.frontName || !planToSave.startDate || !planToSave.dailyRate) {
                    App.ui.showAlert('Preencha todos os campos de configuração da frente.', 'error');
                    return;
                }
                
                const existingIndex = App.state.harvestPlans.findIndex(p => p.id === planToSave.id);

                if (existingIndex > -1) {
                    App.state.harvestPlans[existingIndex] = planToSave;
                } else {
                    planToSave.id = Date.now();
                    App.state.harvestPlans.push(planToSave);
                }
                
                App.data.saveHarvestPlans();
                App.ui.showAlert(`Plano de colheita "${planToSave.frontName}" guardado com sucesso!`, 'success');
                App.ui.showHarvestPlanList();
            },
            deleteHarvestPlan(planId) {
                    if (confirm("Tem a certeza que deseja excluir este plano de colheita? Esta ação é irreversível.")) {
                            App.state.harvestPlans = App.state.harvestPlans.filter(p => p.id != planId);
                            App.data.saveHarvestPlans();
                            App.ui.renderHarvestPlansList();
                            App.ui.showAlert('Plano de colheita excluído.', 'info');
                        }
            },
            addOrUpdateHarvestSequence() {
                if (!App.state.activeHarvestPlan) {
                    App.ui.showAlert("Primeiro crie ou edite um plano.", "warning");
                    return;
                }
                const { fazenda: fazendaSelect, atr: atrInput, editingGroupId, maturador, maturadorDate } = App.elements.harvest;
                const farmCode = fazendaSelect.value;
                const atr = parseFloat(atrInput.value);
                const maturadorValue = maturador.value.trim();
                const maturadorDateValue = maturadorDate.value;
                const isEditing = editingGroupId.value !== '';

                if (!farmCode) { App.ui.showAlert("Selecione uma fazenda.", "warning"); return; }
                if (isNaN(atr) || atr <= 0) { App.ui.showAlert("Insira um valor de ATR válido.", "warning"); return; }

                const selectedCheckboxes = document.querySelectorAll('#harvestTalhaoSelectionList input[type="checkbox"]:checked');
                if (selectedCheckboxes.length === 0) { App.ui.showAlert("Selecione pelo menos um talhão.", "warning"); return; }

                const farm = App.state.fazendas.find(f => f.code === farmCode);
                if (!farm) return;

                const selectedPlots = [];
                let totalArea = 0;
                let totalProducao = 0;

                selectedCheckboxes.forEach(cb => {
                    const talhaoId = parseInt(cb.dataset.talhaoId);
                    const talhao = farm.talhoes.find(t => t.id === talhaoId);
                    if (talhao) {
                        selectedPlots.push({ talhaoId: talhao.id, talhaoName: talhao.name });
                        totalArea += talhao.area;
                        totalProducao += talhao.producao;
                    }
                });

                if (isEditing) {
                    const group = App.state.activeHarvestPlan.sequence.find(g => g.id == editingGroupId.value);
                    if (group) {
                        group.plots = selectedPlots;
                        group.totalArea = totalArea;
                        group.totalProducao = totalProducao;
                        group.atr = atr;
                        group.maturador = maturadorValue;
                        group.maturadorDate = maturadorDateValue;
                    }
                } else {
                    App.state.activeHarvestPlan.sequence.push({
                        id: Date.now(), fazendaCodigo: farm.code, fazendaName: farm.name,
                        plots: selectedPlots, totalArea, totalProducao, atr,
                        maturador: maturadorValue,
                        maturadorDate: maturadorDateValue
                    });
                }
                
                App.ui.renderHarvestSequence();
                this.cancelEditSequence();
            },
            editHarvestSequenceGroup(groupId) {
                if (!App.state.activeHarvestPlan) return;
                const { fazenda, atr, editingGroupId, btnAddOrUpdate, btnCancelEdit, addOrEditTitle, maturador, maturadorDate } = App.elements.harvest;
                const group = App.state.activeHarvestPlan.sequence.find(g => g.id == groupId);
                if (!group) return;

                editingGroupId.value = group.id;
                fazenda.value = group.fazendaCodigo;
                fazenda.disabled = true;
                atr.value = group.atr;
                maturador.value = group.maturador || '';
                maturadorDate.value = group.maturadorDate || '';
                
                const plotIds = group.plots.map(p => p.talhaoId);
                App.ui.renderHarvestTalhaoSelection(group.fazendaCodigo, plotIds);

                addOrEditTitle.innerHTML = `<i class="fas fa-edit"></i> Editar Sequência da Fazenda`;
                btnAddOrUpdate.innerHTML = `<i class="fas fa-save"></i> Atualizar Sequência`;
                btnCancelEdit.style.display = 'inline-flex';
                
                fazenda.scrollIntoView({ behavior: 'smooth', block: 'center' });
            },
            cancelEditSequence() {
                const { fazenda, atr, editingGroupId, btnAddOrUpdate, btnCancelEdit, addOrEditTitle, talhaoSelectionList, maturador, maturadorDate } = App.elements.harvest;
                editingGroupId.value = '';
                fazenda.value = '';
                fazenda.disabled = false;
                atr.value = '';
                maturador.value = '';
                maturadorDate.value = '';
                talhaoSelectionList.innerHTML = '';
                addOrEditTitle.innerHTML = `<i class="fas fa-plus-circle"></i> Adicionar Fazenda à Sequência`;
                btnAddOrUpdate.innerHTML = `<i class="fas fa-plus"></i> Adicionar à Sequência`;
                btnCancelEdit.style.display = 'none';
            },
            removeHarvestSequence(groupId) {
                if (!App.state.activeHarvestPlan) return;
                
                App.state.activeHarvestPlan.sequence = App.state.activeHarvestPlan.sequence.filter(g => g.id != groupId);
                
                App.ui.renderHarvestSequence();
                App.actions.cancelEditSequence(); // Reset form in case we were editing the deleted item
            },
            editHarvestSequenceATR(groupId) {
                if (!App.state.activeHarvestPlan) return;
                const group = App.state.activeHarvestPlan.sequence.find(g => g.id == groupId);
                if (!group) return;

                const newATR = prompt(`Editar ATR para a fazenda ${group.fazendaName}:`, group.atr);
                if (newATR !== null && !isNaN(parseFloat(newATR))) {
                    group.atr = parseFloat(newATR);
                    App.ui.renderHarvestSequence();
                }
            },
            reorderHarvestSequence(draggedId, targetId) {
                if (!App.state.activeHarvestPlan) return;
                const sequence = App.state.activeHarvestPlan.sequence;
                const fromIndex = sequence.findIndex(item => item.id == draggedId);
                const toIndex = sequence.findIndex(item => item.id == targetId);
                if (fromIndex === -1 || toIndex === -1) return;
                const item = sequence.splice(fromIndex, 1)[0];
                sequence.splice(toIndex, 0, item);
                App.ui.renderHarvestSequence();
            },
            calculateAverageAge(group, startDate) {
                let totalAgeInDays = 0;
                let plotsWithDate = 0;
                group.plots.forEach(plot => {
                    const farm = App.state.fazendas.find(f => f.code === group.fazendaCodigo);
                    const talhao = farm?.talhoes.find(t => t.id === plot.talhaoId);
                        if (talhao && talhao.dataUltimaColheita && startDate) {
                        const dataInicioPlano = new Date(startDate + 'T03:00:00Z');
                        const dataUltima = new Date(talhao.dataUltimaColheita + 'T03:00:00Z');
                        if (!isNaN(dataInicioPlano) && !isNaN(dataUltima)) {
                            totalAgeInDays += Math.abs(dataInicioPlano - dataUltima);
                            plotsWithDate++;
                        }
                    }
                });

                if (plotsWithDate > 0) {
                    const avgDiffTime = totalAgeInDays / plotsWithDate;
                    const avgDiffDays = Math.ceil(avgDiffTime / (1000 * 60 * 60 * 24));
                    return (avgDiffDays / 30).toFixed(1);
                }
                return 'N/A';
            },
            calculateMaturadorDays(group) {
                if (!group.maturadorDate) {
                    return 'N/A';
                }
                try {
                    const today = new Date();
                    const applicationDate = new Date(group.maturadorDate + 'T03:00:00Z');
                    const diffTime = today - applicationDate;
                    if (diffTime < 0) return 0;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    return diffDays;
                } catch (e) {
                    return 'N/A';
                }
            },
            saveBrocamento() {
                if (!App.ui.validateFields(['codigo', 'data', 'talhao', 'entrenos', 'brocaBase', 'brocaMeio', 'brocaTopo'])) { App.ui.showAlert("Preencha todos os campos obrigatórios!", "error"); return; }
                
                App.ui.showConfirmationModal('Tem a certeza que deseja guardar esta inspeção de broca?', () => {
                    const { broca } = App.elements;
                    const farm = App.state.fazendas.find(f => f.code === broca.codigo.value.trim());
                    if (!farm) { App.ui.showAlert("Fazenda não encontrada.", "error"); return; }
                    const talhao = farm.talhoes.find(t => t.name.toUpperCase() === broca.talhao.value.trim().toUpperCase());

                    const newEntry = {
                        codigo: broca.codigo.value.trim(), fazenda: farm.name, data: broca.data.value,
                        talhao: broca.talhao.value.trim(), 
                        corte: talhao ? talhao.corte : null,
                        entrenos: parseInt(broca.entrenos.value), 
                        base: parseInt(broca.base.value),
                        meio: parseInt(broca.meio.value),
                        topo: parseInt(broca.topo.value),
                        brocado: parseInt(broca.brocado.value),
                        brocamento: (((parseInt(broca.brocado.value) || 0) / (parseInt(broca.entrenos.value) || 1)) * 100).toFixed(2).replace('.', ','),
                        usuario: App.state.currentUser.username
                    };
                    App.state.registros.push(newEntry); App.data.saveRegistros(); App.ui.showAlert('Inspeção guardada com sucesso!');
                    App.ui.clearForm(broca.form);
                    App.charts.renderAll();
                    this.verificarEAtualizarPlano('broca', newEntry.codigo, newEntry.talhao);
                });
            },
            savePerda() {
                if (!App.ui.validateFields(['dataPerda', 'codigoPerda', 'frenteServico', 'talhaoPerda', 'frotaEquipamento', 'matriculaOperador'])) { App.ui.showAlert("Preencha todos os campos obrigatórios!", "error"); return; }
                
                App.ui.showConfirmationModal('Tem a certeza que deseja guardar este lançamento de perda?', () => {
                    const { perda } = App.elements;
                    const farm = App.state.fazendas.find(f => f.code === perda.codigo.value.trim());
                    const operator = App.state.personnel.find(p => p.matricula === perda.matricula.value.trim());
                    if (!operator) {
                        App.ui.showAlert("Matrícula do operador não encontrada. Verifique o cadastro.", "error");
                        return;
                    }
                    const fields = { canaInteira: parseFloat(perda.canaInteira.value) || 0, tolete: parseFloat(perda.tolete.value) || 0, toco: parseFloat(perda.toco.value) || 0, ponta: parseFloat(perda.ponta.value) || 0, estilhaco: parseFloat(perda.estilhaco.value) || 0, pedaco: parseFloat(perda.pedaco.value) || 0 };
                    const total = Object.values(fields).reduce((s, v) => s + v, 0);
                    const newEntry = { 
                        ...fields, 
                        data: perda.data.value, 
                        codigo: perda.codigo.value.trim(), 
                        fazenda: farm ? farm.name : 'Desconhecida', 
                        frenteServico: perda.frente.value.trim(), 
                        turno: perda.turno.value, 
                        talhao: perda.talhao.value.trim(), 
                        frota: perda.frota.value.trim(),
                        matricula: operator.matricula,
                        operador: operator.name,
                        total, 
                        media: (total / 6).toFixed(2).replace('.', ','), 
                        usuario: App.state.currentUser.username 
                    };
                    App.state.perdas.push(newEntry); App.data.savePerdas(); App.ui.showAlert('Lançamento de perda guardado com sucesso!');
                    App.ui.clearForm(perda.form);
                    App.charts.renderAll();
                    this.verificarEAtualizarPlano('perda', newEntry.codigo, newEntry.talhao);
                });
            },
            deleteEntry(type, index) {
                if (confirm('Tem a certeza que deseja excluir este registo?')) {
                    if (type === 'brocamento') { App.state.registros.splice(index, 1); App.data.saveRegistros(); }
                    else if (type === 'perda') { App.state.perdas.splice(index, 1); App.data.savePerdas(); }
                    App.ui.showAlert('Registo excluído com sucesso!'); App.ui.renderExclusao(); App.charts.renderAll();
                }
            },
            importFarmsFromCSV(file) {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const csv = event.target.result;
                        const lines = csv.split(/\r\n|\n/).filter(line => line.trim() !== '');

                        if (lines.length < 2) {
                            App.ui.showAlert('O ficheiro CSV está vazio ou contém apenas o cabeçalho.', 'error'); return;
                        }
                        const fileHeaders = lines[0].split(';').map(h => h.trim().toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""));
                        const headerIndexes = {
                            farm_code: fileHeaders.indexOf('COD'), farm_name: fileHeaders.indexOf('FAZENDA'),
                            talhao_name: fileHeaders.indexOf('TALHAO'), talhao_area: fileHeaders.indexOf('AREA'),
                            talhao_producao: fileHeaders.indexOf('PRODUCAO'), talhao_variedade: fileHeaders.indexOf('VARIEDADE'),
                            talhao_corte: fileHeaders.indexOf('CORTE'),
                            talhao_distancia: fileHeaders.indexOf('DISTANCIA'),
                            talhao_ultima_colheita: fileHeaders.indexOf('DATAULTIMACOLHEITA'),
                        };

                        if (headerIndexes.farm_code === -1 || headerIndexes.farm_name === -1 || headerIndexes.talhao_name === -1) {
                            App.ui.showAlert('Cabeçalhos essenciais (Cód;FAZENDA;TALHÃO) não encontrados no ficheiro CSV.', 'error'); return;
                        }

                        let updatedCount = 0; let newCount = 0;
                        for (let i = 1; i < lines.length; i++) {
                            const data = lines[i].split(';');
                            if (data.length < 2) continue;
                            
                            const farmCode = data[headerIndexes.farm_code]?.trim();
                            if (!farmCode) continue;

                            let farm = App.state.fazendas.find(f => f.code === farmCode);
                            if (!farm) {
                                farm = {
                                    code: farmCode,
                                    name: data[headerIndexes.farm_name]?.trim().toUpperCase() || `FAZENDA ${farmCode}`,
                                    talhoes: []
                                };
                                App.state.fazendas.push(farm);
                            } else {
                                farm.name = data[headerIndexes.farm_name]?.trim().toUpperCase() || farm.name;
                            }

                            const talhaoName = data[headerIndexes.talhao_name]?.trim().toUpperCase();
                            if(!talhaoName) continue;

                            let talhao = farm.talhoes.find(t => t.name.toUpperCase() === talhaoName);
                            if (talhao) { 
                                talhao.area = parseFloat(data[headerIndexes.talhao_area]?.trim().replace(',', '.')) || talhao.area;
                                talhao.producao = parseFloat(data[headerIndexes.talhao_producao]?.trim().replace(',', '.')) || talhao.producao;
                                talhao.variedade = data[headerIndexes.talhao_variedade]?.trim() || talhao.variedade;
                                talhao.corte = parseInt(data[headerIndexes.talhao_corte]?.trim()) || talhao.corte;
                                talhao.distancia = parseFloat(data[headerIndexes.talhao_distancia]?.trim().replace(',', '.')) || talhao.distancia;
                                talhao.dataUltimaColheita = data[headerIndexes.talhao_ultima_colheita]?.trim() || talhao.dataUltimaColheita;
                                updatedCount++;
                            } else { 
                                farm.talhoes.push({
                                    id: Date.now() + i,
                                    name: talhaoName,
                                    area: parseFloat(data[headerIndexes.talhao_area]?.trim().replace(',', '.')) || 0,
                                    producao: parseFloat(data[headerIndexes.talhao_producao]?.trim().replace(',', '.')) || 0,
                                    variedade: data[headerIndexes.talhao_variedade]?.trim() || '',
                                    corte: parseInt(data[headerIndexes.talhao_corte]?.trim()) || 1,
                                    distancia: parseFloat(data[headerIndexes.talhao_distancia]?.trim().replace(',', '.')) || 0,
                                    dataUltimaColheita: data[headerIndexes.talhao_ultima_colheita]?.trim() || '',
                                });
                                newCount++;
                            }
                        }

                        App.data.saveFazendas();
                        App.ui.renderAllDynamicContent();
                        App.ui.showAlert(`${newCount} talhões adicionados e ${updatedCount} atualizados com sucesso!`, 'success');
                    } catch (e) {
                        App.ui.showAlert('Erro ao processar o ficheiro CSV. Verifique o formato.', 'error');
                        console.error(e);
                    }
                };
                reader.readAsText(file, 'ISO-8859-1');
            },
            downloadCsvTemplate() {
                const headers = "Cód;FAZENDA;TALHÃO;Área;Produção;Variedade;Corte;Distancia;DataUltimaColheita";
                const exampleRow = "4012;FAZ LAGOA CERCADA;T-01;50;4000;RB867515;2;10;2024-07-15";
                const csvContent = "\uFEFF" + headers + "\n" + exampleRow;
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "modelo_cadastro_fazendas.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            },
                importPersonnelFromCSV(file) {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const csv = event.target.result;
                        const lines = csv.split(/\r\n|\n/).filter(line => line.trim() !== '');
                        if (lines.length < 2) { App.ui.showAlert('O ficheiro CSV está vazio ou contém apenas o cabeçalho.', 'error'); return; }
                        const fileHeaders = lines[0].split(';').map(h => h.trim().toUpperCase());
                        const headerIndexes = { matricula: fileHeaders.indexOf('MATRICULA'), name: fileHeaders.indexOf('NOME') };

                        if (headerIndexes.matricula === -1 || headerIndexes.name === -1) {
                            App.ui.showAlert('Cabeçalhos "Matricula" e "Nome" não encontrados.', 'error'); return;
                        }

                        let updatedCount = 0; let newCount = 0;
                        for (let i = 1; i < lines.length; i++) {
                            const data = lines[i].split(';');
                            if (data.length < 2) continue;
                            const matricula = data[headerIndexes.matricula]?.trim();
                            const name = data[headerIndexes.name]?.trim();
                            if (!matricula || !name) continue;

                            let person = App.state.personnel.find(p => p.matricula === matricula);
                            if (person) {
                                person.name = name;
                                updatedCount++;
                            } else {
                                App.state.personnel.push({ id: Date.now() + i, matricula, name });
                                newCount++;
                            }
                        }
                        App.data.savePersonnel();
                        App.ui.renderPersonnelList();
                        App.ui.populateOperatorSelects();
                        App.ui.showAlert(`${newCount} pessoas adicionadas e ${updatedCount} atualizadas.`, 'success');
                    } catch (e) {
                        App.ui.showAlert('Erro ao processar o ficheiro CSV.', 'error');
                        console.error(e);
                    }
                };
                reader.readAsText(file, 'ISO-8859-1');
            },
            downloadPersonnelCsvTemplate() {
                const headers = "Matricula;Nome";
                const exampleRow = "12345;José Almeida";
                const csvContent = "\uFEFF" + headers + "\n" + exampleRow;
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "modelo_cadastro_pessoas.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        },
gemini: {
            getOptimizedHarvestSequence() {
                if (!App.state.activeHarvestPlan || App.state.activeHarvestPlan.sequence.length === 0) {
                    App.ui.showAlert("Adicione fazendas à sequência antes de otimizar.", "warning");
                    return;
                }
                
                App.ui.setLoading(true);

                setTimeout(() => {
                    // Lógica de simulação de IA: Reordena a sequência com base no ATR (maior primeiro)
                    App.state.activeHarvestPlan.sequence.sort((a, b) => (b.atr || 0) - (a.atr || 0));
                    
                    App.ui.setLoading(false);
                    App.ui.renderHarvestSequence();
                    App.ui.showAlert("Sequência de colheita otimizada pela IA (priorizando maior ATR)!", "info");
                }, 2000);
            },
            getDashboardAnalysis() {
                App.ui.showAlert("A análise do dashboard com IA ainda não foi implementada.", "info");
            },
            getPlanningSuggestions() {
                App.ui.showAlert("A sugestão de planeamento com IA ainda não foi implementada.", "info");
            }
        },

        charts: {
            renderAll() { this.renderBrocamentoCharts(); this.renderPerdaCharts(); },
            _createOrUpdateChart(id, config) { const ctx = document.getElementById(id)?.getContext('2d'); if(!ctx) return; if (App.state.charts[id]) { App.state.charts[id].destroy(); } App.state.charts[id] = new Chart(ctx, config); },
            renderBrocamentoCharts() {
                const dadosPorFazenda = App.state.registros.reduce((acc, reg) => { 
                    const fazendaKey = `${reg.codigo} - ${reg.fazenda}`;
                    acc[fazendaKey] = acc[fazendaKey] || []; 
                    acc[fazendaKey].push(parseFloat(reg.brocamento.replace(',', '.'))); 
                    return acc; 
                }, {});
                const labels = Object.keys(dadosPorFazenda).sort((a,b) => parseInt(a) - parseInt(b)); 
                const medias = labels.map(f => (dadosPorFazenda[f].reduce((a,b)=>a+b,0) / dadosPorFazenda[f].length).toFixed(2));
                this._createOrUpdateChart('graficoBrocamento', { type: 'bar', data: { labels, datasets: [{ label: 'Média de Brocamento (%)', data: medias, backgroundColor: '#4caf50' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
                this._createOrUpdateChart('graficoBrocamentoPizza', { type: 'pie', data: { labels, datasets: [{ data: medias, backgroundColor: ['#4caf50', '#2e7d32', '#388e3c', '#66bb6a', '#81c784'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { formatter: (v) => v + '%', color: '#fff' } } }, plugins: [ChartDataLabels] });
                const dadosPorData = App.state.registros.reduce((acc, reg) => { acc[reg.data] = acc[reg.data] || []; acc[reg.data].push(parseFloat(reg.brocamento.replace(',', '.'))); return acc; }, {});
                const datas = Object.keys(dadosPorData).sort(); const mediasPorData = datas.map(d => (dadosPorData[d].reduce((a,b)=>a+b,0) / dadosPorData[d].length).toFixed(2));
                this._createOrUpdateChart('graficoBrocamentoLinha', { type: 'line', data: { labels: datas, datasets: [{ label: 'Evolução do Brocamento (%)', data: mediasPorData, borderColor: '#4caf50', tension: 0.1, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
            },
            renderPerdaCharts() {
                const dadosPorFazenda = App.state.perdas.reduce((acc, p) => { 
                    const fazendaKey = `${p.codigo} - ${p.fazenda}`;
                    acc[fazendaKey] = acc[fazendaKey] || []; 
                    acc[fazendaKey].push(p.total); 
                    return acc; 
                }, {});
                const labels = Object.keys(dadosPorFazenda).sort((a,b) => parseInt(a) - parseInt(b)); 
                const medias = labels.map(f => (dadosPorFazenda[f].reduce((a,b)=>a+b,0) / dadosPorFazenda[f].length).toFixed(2));
                this._createOrUpdateChart('graficoPerda', { type: 'bar', data: { labels, datasets: [{ label: 'Média de Perda (Total)', data: medias, backgroundColor: '#388e3c' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
                const tiposPerda = ['canaInteira', 'tolete', 'toco', 'ponta', 'estilhaco', 'pedaco']; const labelsPerda = ['Cana Inteira', 'Tolete', 'Toco', 'Ponta', 'Estilhaço', 'Pedaço'];
                const dadosPerda = tiposPerda.map(tipo => App.state.perdas.reduce((sum, p) => sum + p[tipo], 0));
                this._createOrUpdateChart('graficoPerdaRadar', { type: 'radar', data: { labels: labelsPerda, datasets: [{ label: 'Total por Tipo de Perda', data: dadosPerda, backgroundColor: 'rgba(56, 142, 60, 0.2)', borderColor: '#388e3c' }] }, options: { responsive: true, maintainAspectRatio: false } });
                const dadosPorData = App.state.perdas.reduce((acc, p) => { acc[p.data] = acc[p.data] || []; acc[p.data].push(p.total); return acc; }, {});
                const datas = Object.keys(dadosPorData).sort(); const mediasPorData = datas.map(d => (dadosPorData[d].reduce((a,b)=>a+b,0) / dadosPorData[d].length).toFixed(2));
                this._createOrUpdateChart('graficoPerdaLinha', { type: 'line', data: { labels: datas, datasets: [{ label: 'Evolução da Perda (Total)', data: mediasPorData, borderColor: '#388e3c', tension: 0.1, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
            }
        },

        reports: {
            _getFilteredData(sourceData, filterElements) {
                let data = [...sourceData];
                const filters = { 
                    fazenda: filterElements.filtroFazenda?.value, 
                    talhao: filterElements.filtroTalhao?.value, 
                    turno: filterElements.filtroTurno?.value, 
                    frente: filterElements.filtroFrente?.value, 
                    operador: filterElements.filtroOperador?.value,
                    inicio: filterElements.filtroInicio?.value, 
                    fim: filterElements.filtroFim?.value, 
                };
                if(filters.fazenda) data = data.filter(d => d.codigo === filters.fazenda); 
                if(filters.talhao) data = data.filter(d => d.talhao.toLowerCase().includes(filters.talhao.toLowerCase())); 
                if(filters.turno) data = data.filter(d => d.turno === filters.turno); 
                if(filters.frente) data = data.filter(d => d.frenteServico.toLowerCase().includes(filters.frente.toLowerCase())); 
                if(filters.operador) data = data.filter(d => d.matricula === filters.operador);
                if(filters.inicio) data = data.filter(d => d.data >= filters.inicio); 
                if(filters.fim) data = data.filter(d => d.data <= filters.fim);
                return data;
            },
            _createPdfWithHeaderFooter(doc, title) {
                const pageCount = doc.internal.getNumberOfPages();
                const logo = App.state.companyLogo;

                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    // HEADER
                    if (logo) {
                        try { doc.addImage(logo, 'PNG', 14, 8, 30, 15); } catch(e) { console.error("Erro ao adicionar logo:", e); }
                    }
                    doc.setFontSize(16);
                    doc.setFont(undefined, 'bold');
                    doc.text(title, doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    doc.text(new Date().toLocaleString('pt-BR'), doc.internal.pageSize.getWidth() - 14, 15, { align: 'right' });
                    doc.setDrawColor(224, 224, 224); // Lighter gray
                    doc.line(14, 22, doc.internal.pageSize.getWidth() - 14, 22);

                    // FOOTER
                    doc.setDrawColor(224, 224, 224);
                    doc.line(14, doc.internal.pageSize.getHeight() - 15, doc.internal.pageSize.getWidth() - 14, doc.internal.pageSize.getHeight() - 15);
                    doc.setFontSize(8);
                    doc.text(`Relatório gerado por: ${App.state.currentUser.username}`, 14, doc.internal.pageSize.getHeight() - 10);
                    doc.text(`Página ${i} de ${pageCount}`, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });
                }

                doc.save(`${title.toLowerCase().replace(/\s/g, '_')}.pdf`); 
                App.ui.showAlert('Relatório PDF gerado com sucesso!');
            },
            _generateCSV(filename, headers, bodyData) {
                let csvContent = "\uFEFF" + headers.map(h => `"${h}"`).join(';') + '\n';
                csvContent += bodyData.map(row => row.map(cell => `"${String(cell || '').replace(/"/g, '""')}"`).join(';')).join('\n');
                const encodedUri = "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent);
                const link = document.createElement("a"); 
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", filename); 
                document.body.appendChild(link); 
                link.click(); 
                document.body.removeChild(link);
                App.ui.showAlert('Relatório Excel (CSV) gerado com sucesso!');
            },
            openHarvestReportModal(planId) {
                const { reportModal } = App.elements.harvest;
                reportModal.overlay.dataset.planId = planId;
                reportModal.overlay.classList.add('show');
            },
            generateCustomHarvestReport(format) {
                const { reportModal } = App.elements.harvest;
                const planId = reportModal.overlay.dataset.planId;
                if (!planId) return;

                const plan = App.state.harvestPlans.find(p => p.id == planId);
                if (!plan) {
                    App.ui.showAlert("Plano não encontrado.", "error");
                    return;
                }

                const options = {};
                reportModal.optionsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    options[cb.dataset.column] = cb.checked;
                });

                const defaultHeaders = ['Seq.', 'Fazenda', 'Talhões', 'Área (ha)', 'Prod. (ton)', 'Entrada', 'Saída'];
                const dynamicHeaders = [];
                if (options.variedade) dynamicHeaders.push('Variedade');
                if (options.idade) dynamicHeaders.push('Idade (m)');
                if (options.atr) dynamicHeaders.push('ATR');
                if (options.maturador) dynamicHeaders.push('Maturador');
                if (options.diasAplicacao) dynamicHeaders.push('Dias Aplic.');

                const fullHeaders = [...defaultHeaders, ...dynamicHeaders];
                const body = [];
                let currentDate = new Date(plan.startDate + 'T03:00:00Z');
                const dailyTon = parseFloat(plan.dailyRate) || 1;

                plan.sequence.forEach((group, index) => {
                    const diasNecessarios = dailyTon > 0 ? group.totalProducao / dailyTon : 0;
                    const dataEntrada = new Date(currentDate.getTime());
                    currentDate.setDate(currentDate.getDate() + diasNecessarios);
                    const dataSaida = new Date(currentDate.getTime());

                    const row = [
                        index + 1,
                        `${group.fazendaCodigo} - ${group.fazendaName}`,
                        group.plots.map(p => p.talhaoName).join(', '),
                        group.totalArea.toFixed(2),
                        group.totalProducao.toFixed(2),
                        dataEntrada.toLocaleDateString('pt-BR'),
                        dataSaida.toLocaleDateString('pt-BR')
                    ];

                    if (options.variedade) {
                        const varieties = new Set();
                        const farm = App.state.fazendas.find(f => f.code === group.fazendaCodigo);
                        group.plots.forEach(plot => {
                            const talhao = farm?.talhoes.find(t => t.id === plot.talhaoId);
                            if (talhao?.variedade) varieties.add(talhao.variedade);
                        });
                        row.push(Array.from(varieties).join(', '));
                    }
                    if (options.idade) row.push(App.actions.calculateAverageAge(group, plan.startDate));
                    if (options.atr) row.push(group.atr || 'N/A');
                    if (options.maturador) row.push(group.maturador || 'N/A');
                    if (options.diasAplicacao) row.push(App.actions.calculateMaturadorDays(group));
                    
                    body.push(row);
                    currentDate.setDate(currentDate.getDate() + 1);
                });

                const reportTitle = `Plano de Colheita - ${plan.frontName}`;
                if (format === 'pdf') {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF({ orientation: 'landscape' });
                    doc.autoTable({
                        head: [fullHeaders],
                        body: body,
                        startY: 25,
                        headStyles: { fillColor: [46, 125, 50], textColor: 255 },
                        alternateRowStyles: { fillColor: [245, 245, 245] },
                        styles: { fontSize: 7 },
                        columnStyles: { 2: { cellWidth: 40 } }
                    });
                    this._createPdfWithHeaderFooter(doc, reportTitle);
                } else if (format === 'csv') {
                    this._generateCSV(`${plan.frontName.replace(/\s+/g, '_')}.csv`, fullHeaders, body);
                }

                reportModal.overlay.classList.remove('show');
            },
            generateBrocamentoPDF() {
                const { filtroInicio, filtroFim, tipoRelatorio } = App.elements.broca;
                if (!filtroInicio.value || !filtroFim.value) {
                    App.ui.showAlert("Por favor, selecione a Data Início e a Data Fim para gerar o relatório.", "warning");
                    return;
                }
                const data = this._getFilteredData(App.state.registros, App.elements.broca);
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape' });
                const title = tipoRelatorio.value === 'A' ? 'Relatório Geral de Brocamento' : 'Relatório de Brocamento por Fazenda';
                const headers = [['Data', 'Talhão', 'Corte', 'Entrenós', 'Brocado', 'Brocamento (%)']];
                
                if (tipoRelatorio.value === 'A') {
                    const body = data.map(r => [r.data, r.talhao, r.corte, r.entrenos, r.brocado, r.brocamento]);
                    doc.autoTable({ head: headers, body: body, startY: 25, headStyles: { fillColor: [46, 125, 50], textColor: 255 }, alternateRowStyles: { fillColor: [245, 245, 245] } });
                } else {
                    let finalY = 25;
                    const groupedData = data.reduce((acc, reg) => {
                        const key = `${reg.codigo} - ${reg.fazenda}`;
                        if (!acc[key]) acc[key] = [];
                        acc[key].push(reg);
                        return acc;
                    }, {});

                    let grandTotalEntrenos = 0;
                    let grandTotalBrocado = 0;

                    Object.keys(groupedData).sort((a,b) => parseInt(a) - parseInt(b)).forEach(fazendaKey => {
                        const farmData = groupedData[fazendaKey];
                        const body = farmData.map(r => [r.data, r.talhao, r.corte, r.entrenos, r.brocado, r.brocamento]);
                        
                        let subTotalEntrenos = farmData.reduce((sum, r) => sum + r.entrenos, 0);
                        let subTotalBrocado = farmData.reduce((sum, r) => sum + r.brocado, 0);
                        grandTotalEntrenos += subTotalEntrenos;
                        grandTotalBrocado += subTotalBrocado;

                        if (finalY > 180) { doc.addPage(); finalY = 25; }
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text(fazendaKey, 14, finalY);
                        
                        doc.autoTable({
                            head: headers, body: body, startY: finalY + 2,
                            headStyles: { fillColor: [46, 125, 50], textColor: 255 },
                            foot: [['Subtotal', '', '', subTotalEntrenos, subTotalBrocado, '']],
                            footStyles: { fillColor: [230, 230, 230], textColor: 0, fontStyle: 'bold' },
                            alternateRowStyles: { fillColor: [245, 245, 245] }
                        });
                        finalY = doc.lastAutoTable.finalY + 10;
                    });
                    
                    if (finalY > 190) { doc.addPage(); finalY = 25; }
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Total Geral: Entrenós: ${grandTotalEntrenos} | Brocado: ${grandTotalBrocado}`, 14, finalY);
                }
                this._createPdfWithHeaderFooter(doc, title);
            },
            generateBrocamentoCSV() {
                    const { filtroInicio, filtroFim, tipoRelatorio } = App.elements.broca;
                if (!filtroInicio.value || !filtroFim.value) {
                    App.ui.showAlert("Por favor, selecione a Data Início e a Data Fim para gerar o relatório.", "warning");
                    return;
                }
                const data = this._getFilteredData(App.state.registros, App.elements.broca);
                const headers = ['Fazenda', 'Data', 'Talhão', 'Corte', 'Entrenós', 'Brocado', 'Brocamento (%)'];
                let body = [];

                if (tipoRelatorio.value === 'A') {
                    body = data.map(r => [`${r.codigo} - ${r.fazenda}`, r.data, r.talhao, r.corte, r.entrenos, r.brocado, r.brocamento]);
                    this._generateCSV('relatorio_geral_brocamento.csv', headers, body);
                } else {
                        const groupedData = data.reduce((acc, reg) => {
                            const key = `${reg.codigo} - ${reg.fazenda}`;
                            if (!acc[key]) acc[key] = [];
                            acc[key].push(reg);
                            return acc;
                        }, {});

                    let grandTotalEntrenos = 0;
                    let grandTotalBrocado = 0;

                    Object.keys(groupedData).sort((a,b) => parseInt(a) - parseInt(b)).forEach(fazendaKey => {
                        const farmData = groupedData[fazendaKey];
                        farmData.forEach(r => {
                            body.push([fazendaKey, r.data, r.talhao, r.corte, r.entrenos, r.brocado, r.brocamento]);
                        });
                        let subTotalEntrenos = farmData.reduce((sum, r) => sum + r.entrenos, 0);
                        let subTotalBrocado = farmData.reduce((sum, r) => sum + r.brocado, 0);
                        grandTotalEntrenos += subTotalEntrenos;
                        grandTotalBrocado += subTotalBrocado;
                        body.push(['Subtotal', '', '', '', subTotalEntrenos, subTotalBrocado, '']);
                    });
                    body.push([]); // Empty line
                    body.push(['Total Geral', '', '', '', grandTotalEntrenos, grandTotalBrocado, '']);
                    this._generateCSV('relatorio_brocamento_por_fazenda.csv', headers, body);
                }
            },
            generatePerdaPDF() {
                const { filtroInicio, filtroFim } = App.elements.perda;
                if (!filtroInicio.value || !filtroFim.value) {
                    App.ui.showAlert("Por favor, selecione a Data Início e a Data Fim para gerar o relatório.", "warning");
                    return;
                }
                const data = this._getFilteredData(App.state.perdas, App.elements.perda); 
                const isDetailed = App.elements.perda.tipoRelatorio.value === 'B';
                const finalTitle = isDetailed ? 'Relatório de Perda Detalhado' : 'Relatório de Perda Resumido';
                
                let headers, body;
                const doc = new jsPDF({ orientation: 'landscape' });
                const formatDate = (dateStr) => new Date(dateStr + 'T03:00:00Z').toLocaleString('pt-BR', { month: 'long', year: 'numeric' });

                if (isDetailed) {
                    headers = [['Mês', 'Fazenda', 'Talhão', 'Frente', 'Turno', 'Operador', 'Frota', 'C.Inteira', 'Tolete', 'Toco', 'Ponta', 'Estilhaço', 'Pedaço', 'Total']];
                    body = data.map(p => [formatDate(p.data), `${p.codigo} - ${p.fazenda}`, p.talhao, p.frenteServico, p.turno, p.operador, p.frota, p.canaInteira, p.tolete, p.toco, p.ponta, p.estilhaco, p.pedaco, p.total]);
                } else {
                    headers = [['Mês', 'Fazenda', 'Talhão', 'Frente', 'Turno', 'Matrícula', 'Frota', 'Total']];
                    body = data.map(p => [formatDate(p.data), `${p.codigo} - ${p.fazenda}`, p.talhao, p.frenteServico, p.turno, p.matricula, p.frota, p.total]);
                }
                
                const grandTotal = data.reduce((sum, p) => sum + p.total, 0);
                const foot = isDetailed ? [['', '', '', '', '', '', '', '', '', '', '', '', 'Total Geral', grandTotal.toFixed(2)]] : [['', '', '', '', '', '', 'Total Geral', grandTotal.toFixed(2)]];

                doc.autoTable({ 
                    head: headers, 
                    body: body, 
                    foot: foot,
                    startY: 25, 
                    headStyles: { fillColor: [46, 125, 50], textColor: 255 },
                    footStyles: { fillColor: [230, 230, 230], textColor: 0, fontStyle: 'bold' },
                    alternateRowStyles: { fillColor: [245, 245, 245] }
                });
                this._createPdfWithHeaderFooter(doc, finalTitle);
            },
            generatePerdaCSV() {
                const { filtroInicio, filtroFim } = App.elements.perda;
                if (!filtroInicio.value || !filtroFim.value) {
                    App.ui.showAlert("Por favor, selecione a Data Início e a Data Fim para gerar o relatório.", "warning");
                    return;
                }
                const data = this._getFilteredData(App.state.perdas, App.elements.perda);
                const isDetailed = App.elements.perda.tipoRelatorio.value === 'B';
                const formatDate = (dateStr) => new Date(dateStr + 'T03:00:00Z').toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                
                let headers, body;

                if(isDetailed) {
                    headers = ['Mês', 'Fazenda', 'Talhão', 'Frente', 'Turno', 'Operador', 'Frota', 'Cana Inteira', 'Tolete', 'Toco', 'Ponta', 'Estilhaço', 'Pedaço', 'Total', 'Média'];
                    body = data.map(p => [formatDate(p.data), `${p.codigo} - ${p.fazenda}`, p.talhao, p.frenteServico, p.turno, p.operador, p.frota, p.canaInteira, p.tolete, p.toco, p.ponta, p.estilhaco, p.pedaco, p.total, p.media]);
                } else {
                    headers = ['Mês', 'Fazenda', 'Talhão', 'Frente', 'Turno', 'Matrícula', 'Frota', 'Total'];
                    body = data.map(p => [formatDate(p.data), `${p.codigo} - ${p.fazenda}`, p.talhao, p.frenteServico, p.turno, p.matricula, p.frota, p.total]);
                }
                
                const grandTotal = data.reduce((sum, p) => sum + p.total, 0);
                body.push([]);
                const totalRow = new Array(headers.length).fill('');
                totalRow[headers.length - (isDetailed ? 2 : 1)] = 'Total Geral';
                totalRow[headers.length - (isDetailed ? 1 : 0)] = grandTotal.toFixed(2);
                body.push(totalRow);
                
                this._generateCSV('relatorio_perda.csv', headers, body);
            },
            generateHarvestPlanPDF(planId = null) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape' });
                let finalY = 25;
                let grandTotalArea = 0;
                let grandTotalProducao = 0;
                let finalEndDate = null;

                const plansToReport = planId 
                    ? App.state.harvestPlans.filter(p => p.id == planId)
                    : App.state.harvestPlans;

                if (plansToReport.length === 0) {
                    App.ui.showAlert("Nenhum plano de colheita para gerar relatório.", "warning");
                    return;
                }

                const reportTitle = planId ? `Relatório do Plano: ${plansToReport[0].frontName}` : "Relatório Geral de Planeamento de Colheita";
                
                plansToReport.forEach((plan, planIndex) => {
                    if (planIndex > 0) doc.addPage();
                    finalY = 25;
                    
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Frente: ${plan.frontName}`, 14, finalY);
                    finalY += 7;

                    const head = [['Seq.', 'Fazenda', 'Talhões', 'Área', 'Prod.', 'ATR', 'Idade (m)', 'Entrada', 'Saída']];
                    const body = [];
                    let currentDate = new Date(plan.startDate + 'T03:00:00Z');
                    const dailyTon = parseFloat(plan.dailyRate) || 1;
                    let subTotalProducao = 0;
                    let subTotalArea = 0;

                    plan.sequence.forEach((group, index) => {
                        const diasNecessarios = dailyTon > 0 ? group.totalProducao / dailyTon : 0;
                        const dataEntrada = new Date(currentDate.getTime());
                        currentDate.setDate(currentDate.getDate() + diasNecessarios);
                        const dataSaida = new Date(currentDate.getTime());
                        const idadeMediaMeses = App.actions.calculateAverageAge(group, plan.startDate);

                        body.push([
                            index + 1, `${group.fazendaCodigo} - ${group.fazendaName}`, group.plots.map(p => p.talhaoName).join(', '),
                            group.totalArea.toFixed(2), group.totalProducao.toFixed(2), group.atr,
                            idadeMediaMeses, dataEntrada.toLocaleDateString('pt-BR'), dataSaida.toLocaleDateString('pt-BR')
                        ]);
                        currentDate.setDate(currentDate.getDate() + 1);
                        subTotalProducao += group.totalProducao;
                        subTotalArea += group.totalArea;
                    });
                    
                    grandTotalProducao += subTotalProducao;
                    grandTotalArea += subTotalArea;
                    finalEndDate = currentDate;

                    doc.autoTable({
                        head: head, body: body, startY: finalY,
                        headStyles: { fillColor: [46, 125, 50], textColor: 255 },
                        foot: [['Subtotal', '', '', subTotalArea.toFixed(2), subTotalProducao.toFixed(2), '', '', '', '']],
                        footStyles: { fillColor: [230, 230, 230], textColor: 0, fontStyle: 'bold' },
                        alternateRowStyles: { fillColor: [245, 245, 245] },
                        styles: { fontSize: 8 },
                        columnStyles: { 2: { cellWidth: 50 } },
                    });
                    finalY = doc.lastAutoTable.finalY + 10;
                });
                
                // Grand Total
                if (finalY > 190) { doc.addPage(); finalY = 25; }
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text(`Resumo Geral da Safra:`, 14, finalY);
                finalY += 7;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`- Produção Total Estimada: ${grandTotalProducao.toFixed(2)} ton`, 14, finalY);
                finalY += 5;
                doc.text(`- Área Total: ${grandTotalArea.toFixed(2)} ha`, 14, finalY);
                finalY += 5;
                doc.text(`- Previsão de Término da Safra: ${new Date(finalEndDate.getTime() - (24*60*60*1000)).toLocaleDateString('pt-BR')}`, 14, finalY);

                this._createPdfWithHeaderFooter(doc, reportTitle);
            },
            generateHarvestPlanCSV(planId = null) {
                const plansToReport = planId
                    ? App.state.harvestPlans.filter(p => p.id == planId)
                    : App.state.harvestPlans;

                if (plansToReport.length === 0) {
                    App.ui.showAlert("Nenhum plano de colheita para gerar relatório.", "warning");
                    return;
                }

                const reportTitle = planId ? `plano_${plansToReport[0].frontName.toLowerCase().replace(/\s/g, '_')}.csv` : "planejamento_geral_colheita.csv";
                const headers = ['Frente', 'Seq.', 'Fazenda', 'Talhões', 'Área (ha)', 'Produção (ton)', 'ATR', 'Idade (meses)', 'Entrada', 'Saída'];
                const body = [];
                let grandTotalArea = 0;
                let grandTotalProducao = 0;
                let finalEndDate = null;

                plansToReport.forEach(plan => {
                    let currentDate = new Date(plan.startDate + 'T03:00:00Z');
                    const dailyTon = parseFloat(plan.dailyRate) || 1;

                    plan.sequence.forEach((group, index) => {
                        const diasNecessarios = dailyTon > 0 ? group.totalProducao / dailyTon : 0;
                        const dataEntrada = new Date(currentDate.getTime());
                        currentDate.setDate(currentDate.getDate() + diasNecessarios);
                        const dataSaida = new Date(currentDate.getTime());
                        const idadeMediaMeses = App.actions.calculateAverageAge(group, plan.startDate);

                        body.push([
                            plan.frontName, index + 1, `${group.fazendaCodigo} - ${group.fazendaName}`,
                            group.plots.map(p => p.talhaoName).join('; '),
                            group.totalArea.toFixed(2), group.totalProducao.toFixed(2),
                            group.atr, idadeMediaMeses, dataEntrada.toLocaleDateString('pt-BR'),
                            dataSaida.toLocaleDateString('pt-BR')
                        ]);
                        currentDate.setDate(currentDate.getDate() + 1);
                        grandTotalProducao += group.totalProducao;
                        grandTotalArea += group.totalArea;
                    });
                    finalEndDate = currentDate;
                });
                
                // Add summary rows
                body.push([]); // Blank line
                body.push(['Resumo Geral da Safra']);
                body.push(['Produção Total (ton)', grandTotalProducao.toFixed(2)]);
                body.push(['Área Total (ha)', grandTotalArea.toFixed(2)]);
                body.push(['Previsão de Término', new Date(finalEndDate.getTime() - (24*60*60*1000)).toLocaleDateString('pt-BR')]);

                this._generateCSV(reportTitle, headers, body);
            }
        }
    };
    
    App.init();

    });
    </script>
</body>
</html>
